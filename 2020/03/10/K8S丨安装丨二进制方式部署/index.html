<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/j-icon-16.png?v=2.0.1" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/j-icon-32.png?v=2.0.1" type="image/png" sizes="32x32"><link rel="apple-touch-icon" href="/images/icons/j-icon-192.png?v=2.0.1" sizes="180x180"><link rel="mask-icon" href="/images/icons/j-icon-96.png?v=2.0.1" color="#54bcff"><meta name="msapplication-TileImage" content="/images/icons/j-icon-144.png"><meta name="msapplication-TileColor" content="#000000"><meta name="google-site-verification" content="wmgiquHvFLol6wowL0KAwg0WI7DkfhhVJ3r0_QRPk-g"><meta name="baidu-site-verification" content="code-nyFNxfLcDt"><meta name="360-site-verification" content="0d8d7a290d96dfee3f3c05e8e0500347"><meta name="description" content="这些年来，谷歌开发出了一个叫&#96;Borg&#96;的内部系统（后来还有一个新系统叫&#96;omega&#96;），应用开发者和系统管理员管理那些数以千计的应用程序和服务都受益于它的帮助。除了简化开发和管理，它也帮助他们获得了更高的基础设施利用率，在你的组织如此庞大时，这很重要。当你运行成千上万台机器时，哪怕一丁点的利用率提升也意味着节约了数百万美元，所以，开发这个系统的动机是显而易见的。在保守&#96;Borg&#96;和&#96;Omega&#96;">
<meta property="og:type" content="article">
<meta property="og:title" content="K8S丨安装丨二进制方式部署">
<meta property="og:url" content="https://jeremy-zjl.github.io/2020/03/10/K8S%E4%B8%A8%E5%AE%89%E8%A3%85%E4%B8%A8%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%B9%E5%BC%8F%E9%83%A8%E7%BD%B2/index.html">
<meta property="og:site_name" content="Jeremy-ZJL&#39;s Blog">
<meta property="og:description" content="这些年来，谷歌开发出了一个叫&#96;Borg&#96;的内部系统（后来还有一个新系统叫&#96;omega&#96;），应用开发者和系统管理员管理那些数以千计的应用程序和服务都受益于它的帮助。除了简化开发和管理，它也帮助他们获得了更高的基础设施利用率，在你的组织如此庞大时，这很重要。当你运行成千上万台机器时，哪怕一丁点的利用率提升也意味着节约了数百万美元，所以，开发这个系统的动机是显而易见的。在保守&#96;Borg&#96;和&#96;Omega&#96;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jeremy-zjl.github.io/images/k8s-png/1.named.conf.png">
<meta property="og:image" content="https://jeremy-zjl.github.io/images/k8s-png/2.dns%E6%B5%8B%E8%AF%95.png">
<meta property="og:image" content="https://jeremy-zjl.github.io/images/k8s-png/3.%E7%9F%AD%E5%9F%9F%E5%90%8D%E6%B5%8B%E8%AF%95.png">
<meta property="og:image" content="https://jeremy-zjl.github.io/images/k8s-png/4.etcd%E5%90%84%E8%8A%82%E7%82%B9%E5%81%A5%E5%BA%B7%E6%83%85%E5%86%B5.png">
<meta property="og:image" content="https://jeremy-zjl.github.io/images/k8s-png/5.etcd%E5%90%84%E8%8A%82%E7%82%B9%E7%8A%B6%E6%80%81%E6%83%85%E5%86%B5.png">
<meta property="og:image" content="https://jeremy-zjl.github.io/images/k8s-png/6.harbor-%E7%94%A8docker-compose%E6%9F%A5%E7%9C%8B.png">
<meta property="og:image" content="https://jeremy-zjl.github.io/images/k8s-png/7.harbor-%E6%B7%BB%E5%8A%A0dns%E8%AE%B0%E5%BD%95.png">
<meta property="og:image" content="https://jeremy-zjl.github.io/images/k8s-png/8.%E8%AE%BF%E9%97%AEharbor.png">
<meta property="og:image" content="https://jeremy-zjl.github.io/images/k8s-png/9.%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AApublic%E5%BA%93.png">
<meta property="og:image" content="https://jeremy-zjl.github.io/images/k8s-png/11.l4%E8%B4%9F%E8%BD%BD%E5%9B%BE.png">
<meta property="og:image" content="https://jeremy-zjl.github.io/images/k8s-png/12.%E6%9F%A5%E7%9C%8Bkubelet%E8%AF%81%E4%B9%A6%E8%AF%B7%E6%B1%82.png">
<meta property="og:image" content="https://jeremy-zjl.github.io/images/k8s-png/13.%E6%89%B9%E5%87%86%E7%94%B3%E8%AF%B7-1.png">
<meta property="og:image" content="https://jeremy-zjl.github.io/images/k8s-png/13.%E6%89%B9%E5%87%86%E7%94%B3%E8%AF%B7-2.png">
<meta property="og:image" content="https://jeremy-zjl.github.io/images/k8s-png/14.%E5%9C%A8kubelet%E4%B8%AD%E6%8C%87%E5%AE%9A%E4%B8%89%E4%B8%AA%E5%8F%82%E6%95%B0.png">
<meta property="og:image" content="https://jeremy-zjl.github.io/images/k8s-png/17.Dashboard%E7%AE%80%E4%BB%8B%E5%9B%BE.png">
<meta property="og:image" content="https://jeremy-zjl.github.io/images/k8s-png/18.Dashboard-github.png">
<meta property="og:image" content="https://jeremy-zjl.github.io/images/k8s-png/19.recommended.yaml.png">
<meta property="og:image" content="https://jeremy-zjl.github.io/images/k8s-png/20.%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AEdashboard.png">
<meta property="og:image" content="https://jeremy-zjl.github.io/images/k8s-png/21.%E6%9F%A5%E7%9C%8Badmin-user%E8%B4%A6%E6%88%B7%E7%9A%84token.png">
<meta property="og:image" content="https://jeremy-zjl.github.io/images/k8s-png/22.%E7%99%BB%E5%BD%95dashboard-1.png">
<meta property="og:image" content="https://jeremy-zjl.github.io/images/k8s-png/22.%E7%99%BB%E5%BD%95dashboard-2.png">
<meta property="article:published_time" content="2020-03-10T02:10:10.000Z">
<meta property="article:modified_time" content="2020-11-10T03:10:16.000Z">
<meta property="article:author" content="Jeremy-ZJL">
<meta property="article:tag" content="K8S">
<meta property="article:tag" content="Kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jeremy-zjl.github.io/images/k8s-png/1.named.conf.png"><meta name="keywords" content="Jeremy-ZJL, Jeremy-ZJL's Blog"><meta name="description" content="Jeremy-ZJL's Blog"><title>K8S丨安装丨二进制方式部署 | Jeremy-ZJL's Blog</title><link ref="canonical" href="https://jeremy-zjl.github.io/2020/03/10/K8S%E4%B8%A8%E5%AE%89%E8%A3%85%E4%B8%A8%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%B9%E5%BC%8F%E9%83%A8%E7%BD%B2/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.0.1"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="dns-prefetch" href="https://hm.baidu.com"><script src="https://www.googletagmanager.com/gtag/js?id=183330495" async="" data-pjax=""></script><script data-pjax="">if (window.location.hostname !== 'localhost') {
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', '183330495');
}</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement('script');
  hm.src = 'https://hm.baidu.com/hm.js?77b4b897986a377c76b267d13173877e';
  hm.async = true;

  if (true) {
    hm.setAttribute('data-pjax', '');
  }
  var s = document.getElementsByTagName('script')[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: undefined,
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"ocean","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: {"avoidBanner":false},
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 4.2.1"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner header-inner--height header-inner--bgcolor"><nav class="header-nav header-nav--sticky"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="javascript:;" onclick="return false;"><span class="header-nav-menu-item__icon"><i class="fas fa-angle-double-down"></i></span><span class="header-nav-menu-item__text">其它</span></a><div class="header-nav-submenu"><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/xxx1-1/"><span class="header-nav-submenu-item__icon"><i class="fa(s|r|l|d|b) fa-xxx"></i></span><span class="header-nav-submenu-item__text">其它-1</span></a></div><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/xxx1-2/"><span class="header-nav-submenu-item__icon"><i class="fa(s|r|l|d|b) fa-xxx"></i></span><span class="header-nav-submenu-item__text">其它-2</span></a></div></div></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><div class="sticky-top" data-popover="置顶文章" data-popover-pos="up"><span class="sticky-top__icon"><i class="fas fa-thumbtack"></i></span></div><h1 class="post-title">K8S丨安装丨二进制方式部署</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2020-03-10</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2020-11-10</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">9.7k</span></span><span class="post-meta-item post-meta-item--visitors"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">阅读次数</span><span class="post-meta-item__value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body">
        <h1 id="1-环境说明"   >
          <a href="#1-环境说明" class="heading-link"><i class="fas fa-link"></i></a>1. 环境说明</h1>
      <p><strong>机器说明：</strong></p>
<ul>
<li><strong>k8s-master1</strong>：<code>192.168.1.53</code><ul>
<li>kube-apiserver</li>
<li>kube-controller-manager</li>
<li>kube-scheduler</li>
<li>etcd</li>
</ul>
</li>
<li><strong>k8s-master2</strong>：<code>192.168.1.54</code><ul>
<li>kube-apiserver</li>
<li>kube-controller-manager</li>
<li>kube-scheduler</li>
</ul>
</li>
<li><strong>k8s-node1</strong>：<code>192.168.1.61</code><ul>
<li>kubelet</li>
<li>kube-proxy</li>
<li>docker</li>
<li>etcd</li>
</ul>
</li>
<li><strong>k8s-node2</strong>：<code>192.168.1.62</code><ul>
<li>kubelet</li>
<li>kube-proxy</li>
<li>docker</li>
<li>etcd</li>
</ul>
</li>
<li><strong>Load Balancer-Master</strong>：<code>192.168.1.51</code>  -  <strong>192.168.1.50</strong>(VIP)<ul>
<li>Nginx L4</li>
</ul>
</li>
<li><strong>Load Balancer-Backup</strong>：<code>192.168.1.52</code><ul>
<li>Nginx L4</li>
</ul>
</li>
<li><strong>harbor</strong>：<code>192.168.1.59</code><ul>
<li>harbor</li>
</ul>
</li>
<li><strong>dns</strong>：<code>192.168.1.55</code><ul>
<li>DNS</li>
</ul>
</li>
</ul>
<p>子网：<code>192.168.1.0/21</code><br>网关：<code>192.168.1.1</code></p>

        <h2 id="1-1-阿里yum源，epel源"   >
          <a href="#1-1-阿里yum源，epel源" class="heading-link"><i class="fas fa-link"></i></a>1.1 阿里yum源，epel源</h2>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># centos7</span></span><br><span class="line">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># epel源</span></span><br><span class="line">mv /etc/yum.repos.d/epel.repo /etc/yum.repos.d/epel.repo.backup</span><br><span class="line">mv /etc/yum.repos.d/epel-testing.repo /etc/yum.repos.d/epel-testing.repo.backup</span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br></pre></td></tr></table></div></figure>


        <h2 id="1-2-关闭防火墙、selinux、swap，设置hostname，时间同步"   >
          <a href="#1-2-关闭防火墙、selinux、swap，设置hostname，时间同步" class="heading-link"><i class="fas fa-link"></i></a>1.2 关闭防火墙、selinux、swap，设置hostname，时间同步</h2>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld &amp;&amp; systemctl <span class="built_in">disable</span> firewalld </span><br><span class="line">sed -i.bak <span class="string">'s/SELINUX=enforcing/SELINUX=disabled/'</span> /etc/selinux/config </span><br><span class="line"><span class="comment"># 重启生效 或 setenforce 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭swap</span></span><br><span class="line">swapoff -a  <span class="comment"># 临时</span></span><br><span class="line">sed -ri <span class="string">'s/.*swap.*/#&amp;/'</span> /etc/fstab    <span class="comment"># 永久</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据规划设置主机名</span></span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname &lt;hostname&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加hosts</span></span><br><span class="line"><span class="comment">## 本实例搭建了dns服务器，如果没有dns，则需要将各机器的hostname对应ip写到host文件内</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 时间同步</span></span><br><span class="line">ntpdate ntp1.aliyun.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 时间同步定时任务</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'# time sync by jeremy at 2020-11-10'</span> &gt;&gt;/var/spool/cron/root</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'* */6 * * * /usr/sbin/ntpdate ntp1.aliyun.com &gt;/dev/null 2&gt;&amp;1'</span> &gt;&gt;/var/spool/cron/root</span><br><span class="line">crontab -l</span><br></pre></td></tr></table></div></figure>


        <h2 id="1-3-Linux内核优化"   >
          <a href="#1-3-Linux内核优化" class="heading-link"><i class="fas fa-link"></i></a>1.3 Linux内核优化</h2>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt;/etc/sysctl.conf&lt;&lt;EOF</span><br><span class="line">net.ipv4.tcp_fin_timeout = 2</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_tw_recycle = 1</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_keepalive_time = 600</span><br><span class="line">net.ipv4.ip_local_port_range = 4000 65000</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 16384</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 36000</span><br><span class="line">net.ipv4.route.gc_timeout = 100</span><br><span class="line">net.ipv4.tcp_syn_retries = 1</span><br><span class="line">net.ipv4.tcp_synack_retries = 1</span><br><span class="line">net.core.somaxconn = 16384</span><br><span class="line">net.core.netdev_max_backlog = 16384</span><br><span class="line">net.ipv4.tcp_max_orphans = 16384</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启（建议）</span></span><br><span class="line">reboot</span><br></pre></td></tr></table></div></figure>


        <h2 id="1-4-必要工具"   >
          <a href="#1-4-必要工具" class="heading-link"><i class="fas fa-link"></i></a>1.4 必要工具</h2>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install wget net-tools telnet tree nmap sysstat lrzsz dos2unix <span class="built_in">bind</span>-utils</span><br></pre></td></tr></table></div></figure>


        <h1 id="2-DNS部署"   >
          <a href="#2-DNS部署" class="heading-link"><i class="fas fa-link"></i></a>2. DNS部署</h1>
      <blockquote>
<p>使用Linux的bind服务来实现DNS，在ingress中实现七层代理，在实验环境中就得绑定hosts方式实现访问，而且容器也没办法绑定hosts，这里通过DNS来实现。</p>
</blockquote>
<p><strong>BIND的配置文件及工作目录</strong></p>
<ul>
<li><code>/etc/named.conf</code>: named主配置文件，定义各种运行参数</li>
<li><code>/etc/named.rfc1912.zones</code>: 定义各区域的配置文件</li>
<li><code>/var/named/</code>: 资源记录文档的存放位置</li>
<li><code>/var/named/slaves</code>: 从服务器的资源配置文件存放路径</li>
</ul>

        <h2 id="2-1-安装"   >
          <a href="#2-1-安装" class="heading-link"><i class="fas fa-link"></i></a>2.1 安装</h2>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install <span class="built_in">bind</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="2-2-主配置文件"   >
          <a href="#2-2-主配置文件" class="heading-link"><i class="fas fa-link"></i></a>2.2 主配置文件</h2>
      <ul>
<li><code>vim /etc/named.conf</code><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">listen-on port 53 &#123; 192.168.1.55; &#125;; <span class="comment"># dns监听地址 </span></span><br><span class="line">allow-query &#123; any; &#125;; <span class="comment"># 允许所有主机访问dns服务 </span></span><br><span class="line">forwarders &#123; 192.168.1.1; &#125;; <span class="comment"># 指定上级dns </span></span><br><span class="line">recursion yes; <span class="comment"># dns采用递归算法查询（另一种是迭代） </span></span><br><span class="line">dnssec-enable no; <span class="comment"># 关闭dnssec功能选项 节约资源将其关闭 </span></span><br><span class="line">dnssec-validation no; <span class="comment"># 关闭dnssec功能选项 节约资源将其关闭</span></span><br><span class="line">dnssec-lookaside no;   <span class="comment"># 关闭dnssec功能选项 节约资源将其关闭</span></span><br></pre></td></tr></table></div></figure>

</li>
</ul>
<p><img src="/images/k8s-png/1.named.conf.png" alt="1.named.conf.png"></p>
<ul>
<li><strong>配置文件语法校验</strong><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 没有报错说明语法没问题</span></span><br><span class="line">named-checkconf</span><br></pre></td></tr></table></div></figure>

</li>
</ul>

        <h2 id="2-3-区域配置文件"   >
          <a href="#2-3-区域配置文件" class="heading-link"><i class="fas fa-link"></i></a>2.3 区域配置文件</h2>
      <ul>
<li><code>vim /etc/named.rfc1912.zones</code><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">zone <span class="string">"host.com"</span> IN &#123;</span><br><span class="line">        <span class="built_in">type</span> master;</span><br><span class="line">        file <span class="string">"host.com.zone"</span>;</span><br><span class="line">        allow-update &#123; 192.168.1.55; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone <span class="string">"jeremy.cn"</span> IN &#123;</span><br><span class="line">        <span class="built_in">type</span> master;</span><br><span class="line">        file <span class="string">"jeremy.cn.zone"</span>;</span><br><span class="line">        allow-update &#123; 192.168.1.55; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

</li>
</ul>

        <h2 id="2-4-配置区域数据文件"   >
          <a href="#2-4-配置区域数据文件" class="heading-link"><i class="fas fa-link"></i></a>2.4 配置区域数据文件</h2>
      <ul>
<li><p><code>vim /var/named/host.com.zone</code></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ORIGIN</span> host.com.</span><br><span class="line"><span class="variable">$TTL</span> 600        ; 10 minutes</span><br><span class="line">@               IN SOA  dns.host.com. dnsadmin.host.com. (</span><br><span class="line">                                2020102801 ; serial</span><br><span class="line">                                10800      ; refresh (3 hours)</span><br><span class="line">                                900        ; retry (15 minutes)</span><br><span class="line">                                604800     ; expire (1 week)</span><br><span class="line">                                86400      ; minimum (1 day)</span><br><span class="line">                                )</span><br><span class="line">                                NS   dns.host.com.</span><br><span class="line"><span class="variable">$TTL</span> 60 ; 1 minute</span><br><span class="line">dns                A    192.168.1.55</span><br><span class="line">harbor             A    192.168.1.59</span><br><span class="line">k8s-master1        A    192.168.1.53</span><br><span class="line">k8s-master2        A    192.168.1.54</span><br><span class="line">k8s-node1          A    192.168.1.61</span><br><span class="line">k8s-node2          A    192.168.1.62</span><br></pre></td></tr></table></div></figure>
</li>
<li><p><code>vim /var/named/jeremy.cn.zone</code></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ORIGIN</span> jeremy.cn.</span><br><span class="line"><span class="variable">$TTL</span> 600        ; 10 minutes</span><br><span class="line">@               IN SOA  dns.jeremy.cn. dnsadmin.jeremy.cn. (</span><br><span class="line">                                2020102801 ; serial</span><br><span class="line">                                10800      ; refresh (3 hours)</span><br><span class="line">                                900        ; retry (15 minutes)</span><br><span class="line">                                604800     ; expire (1 week)</span><br><span class="line">                                86400      ; minimum (1 day)</span><br><span class="line">                                )</span><br><span class="line">                                NS   dns.jeremy.cn.</span><br><span class="line"><span class="variable">$TTL</span> 60 ; 1 minute</span><br><span class="line">dns                A    192.168.1.55</span><br></pre></td></tr></table></div></figure>

</li>
</ul>

        <h2 id="2-5-启动DNS服务"   >
          <a href="#2-5-启动DNS服务" class="heading-link"><i class="fas fa-link"></i></a>2.5 启动DNS服务</h2>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start named &amp;&amp; systemctl <span class="built_in">enable</span> named</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-6-验证是否可解析"   >
          <a href="#2-6-验证是否可解析" class="heading-link"><i class="fas fa-link"></i></a>2.6 验证是否可解析</h2>
      <ul>
<li><p><strong>检验</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ~]<span class="comment"># dig -t A k8s-master1.host.com @192.168.1.55 +short</span></span><br><span class="line">192.168.1.53</span><br><span class="line">[root@harbor ~]<span class="comment"># dig -t A k8s-master2.host.com @192.168.1.55 +short</span></span><br><span class="line">192.168.1.54</span><br><span class="line">[root@harbor ~]<span class="comment"># dig -t A k8s-node1.host.com @192.168.1.55 +short</span></span><br><span class="line">192.168.1.61</span><br></pre></td></tr></table></div></figure>
</li>
<li><p><strong>将所有节点的DNS指向我们搭建的DNS服务器上，再进行测试。</strong></p>
</li>
</ul>
<p><img src="/images/k8s-png/2.dns%E6%B5%8B%E8%AF%95.png" alt="2.dns测试.png"></p>

        <h2 id="2-7-设置search-短域名"   >
          <a href="#2-7-设置search-短域名" class="heading-link"><i class="fas fa-link"></i></a>2.7 设置search(短域名)</h2>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nmcli con modify ens192 ipv4.dns-search host.com</span><br><span class="line">systemctl restart network</span><br></pre></td></tr></table></div></figure>

<p><img src="/images/k8s-png/3.%E7%9F%AD%E5%9F%9F%E5%90%8D%E6%B5%8B%E8%AF%95.png" alt="3.短域名测试.png"></p>

        <h1 id="3-创建TLS证书及密钥"   >
          <a href="#3-创建TLS证书及密钥" class="heading-link"><i class="fas fa-link"></i></a>3. 创建TLS证书及密钥</h1>
      <blockquote>
<p><code>Kubernetes</code>系统的各组件需要使用 <code>TLS</code> 证书对通信进行加密，本文档使用 <code>CloudFlare 的 PKI</code> 工具集 <code>cfssl</code> 来生成 <code>Certificate Authority (CA)</code> 和其它证书；</p>
</blockquote>

        <h2 id="3-1-证书说明"   >
          <a href="#3-1-证书说明" class="heading-link"><i class="fas fa-link"></i></a>3.1 证书说明</h2>
      <ul>
<li><p><strong>集群TLS认证需要的证书及密钥如下：</strong></p>
<ul>
<li><code>ca.pem</code></li>
<li><code>ca-key.pem</code></li>
<li><code>etcd.pem</code></li>
<li><code>etcd-key.pem</code></li>
<li><code>apiserver.pem</code></li>
<li><code>apiserver-key.pem</code></li>
<li><code>client.pem</code></li>
<li><code>client-key.pem</code></li>
<li><code>kubelet.pem</code>(本实例没用)</li>
<li><code>kubelet-key.pem</code>(本实例没用)</li>
<li><code>kube-proxy.pem</code></li>
<li><code>kube-proxy-key.pem</code></li>
</ul>
</li>
<li><p><strong>集群各组件对证书的依赖如下：</strong></p>
<ul>
<li><code>etcd</code>: 使用 <code>ca.pem</code>, <code>etcd.pem</code>, <code>etcd-key.pem</code>；</li>
<li><code>kube-apiserver</code>: 使用 <code>ca.pem</code>, <code>ca-key.pem</code>, <code>apiserver.pem</code>, <code>apiserver-key.pem</code>, <code>client.pem</code>, <code>client-key.pem</code>, <code>etcd.pem</code>, <code>etcd-key.pem</code>；</li>
<li><code>kube-controller-manager</code>: 使用 <code>ca.pem</code>, <code>ca-key.pem</code>；</li>
<li><code>kube-scheduler</code>：没有；</li>
<li><code>kubelet</code>: 没有；</li>
<li><code>kube-proxy</code>: 使用 <code>ca.pem</code>, <code>kube-proxy.pem</code>, <code>kube-proxy-key.pem</code>；</li>
</ul>
</li>
</ul>

        <h2 id="3-2-安装证书制作工具-CFSSL"   >
          <a href="#3-2-安装证书制作工具-CFSSL" class="heading-link"><i class="fas fa-link"></i></a>3.2 安装证书制作工具-CFSSL</h2>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/<span class="built_in">local</span>/bin/cfssl </span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/<span class="built_in">local</span>/bin/cfssl-json </span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/<span class="built_in">local</span>/bin/cfssl-certinfo </span><br><span class="line">chmod +x /usr/<span class="built_in">local</span>/bin/cfssl*</span><br></pre></td></tr></table></div></figure>

<blockquote>
<ul>
<li><strong>关于CFSSL</strong></li>
<li><code>cfssl</code>：证书签发的主要工具</li>
<li><code>cfssl-json</code>：将cfssl生成的整数（json格式）变为文件承载式证书</li>
<li><code>cfssl-certinfo</code>：验证证书的信息</li>
</ul>
</blockquote>

        <h2 id="3-3-创建ca-pem和ca-key-pem"   >
          <a href="#3-3-创建ca-pem和ca-key-pem" class="heading-link"><i class="fas fa-link"></i></a>3.3 创建ca.pem和ca-key.pem</h2>
      
        <h3 id="3-3-1-CA配置文件"   >
          <a href="#3-3-1-CA配置文件" class="heading-link"><i class="fas fa-link"></i></a>3.3.1 CA配置文件</h3>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在harbor主机上制作证书，然后发放</span></span><br><span class="line">mkdir -p ssl &amp;&amp; <span class="built_in">cd</span> ssl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 过期时间设置成了 87600h </span></span><br><span class="line"></span><br><span class="line">cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"signing"</span>: &#123;</span><br><span class="line">        <span class="string">"default"</span>: &#123;</span><br><span class="line">            <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">        &#125;, </span><br><span class="line">        <span class="string">"profiles"</span>: &#123;</span><br><span class="line">            <span class="string">"server"</span>: &#123;</span><br><span class="line">                <span class="string">"expiry"</span>: <span class="string">"87600h"</span>, </span><br><span class="line">                <span class="string">"usages"</span>: [</span><br><span class="line">                    <span class="string">"signing"</span>, </span><br><span class="line">                    <span class="string">"key encipherment"</span>, </span><br><span class="line">                    <span class="string">"server auth"</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;, </span><br><span class="line">            <span class="string">"client"</span>: &#123;</span><br><span class="line">                <span class="string">"expiry"</span>: <span class="string">"87600h"</span>, </span><br><span class="line">                <span class="string">"usages"</span>: [</span><br><span class="line">                    <span class="string">"signing"</span>, </span><br><span class="line">                    <span class="string">"key encipherment"</span>, </span><br><span class="line">                    <span class="string">"client auth"</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;, </span><br><span class="line">            <span class="string">"peer"</span>: &#123;</span><br><span class="line">                <span class="string">"expiry"</span>: <span class="string">"87600h"</span>, </span><br><span class="line">                <span class="string">"usages"</span>: [</span><br><span class="line">                    <span class="string">"signing"</span>, </span><br><span class="line">                    <span class="string">"key encipherment"</span>, </span><br><span class="line">                    <span class="string">"server auth"</span>, </span><br><span class="line">                    <span class="string">"client auth"</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p><strong>字段说明：</strong><br><code>ca-config.json</code>：可以定义多个<code>profiles</code>，分别指定不同的过期时间、使用场景等参数；后续在签名证书时使用某个<code>profile</code>；<br><code>signing</code>：表示该证书可用于签名其它证书；生成的<code>ca.pem</code>证书中<code>CA=TRUE</code>；<br><code>server auth</code>：表示<code>client</code>可以用该 CA 对server提供的证书进行验证；<br><code>client auth</code>：表示<code>server</code>可以用该 CA 对client提供的证书进行验证；<br><code>87600h</code>：十年</p>
</blockquote>
<blockquote>
<p><strong>证书类型</strong><br><code>client</code>：客户端使用，用于服务端认证客户端，例如<code>etcd</code>、<code>proxy</code>、<code>fleetctl</code>、<code>docker客户端</code>。<br><code>server</code>：服务端使用，客户端以此验证服务端身份，例如<code>docker服务端</code>、<code>kube-apiserver</code><br><code>peer</code>：双向证书，用于etcd集群成员间通信</p>
</blockquote>

        <h3 id="3-3-2-CA证书申请表-生成CA自签名请求"   >
          <a href="#3-3-2-CA证书申请表-生成CA自签名请求" class="heading-link"><i class="fas fa-link"></i></a>3.3.2 CA证书申请表(生成CA自签名请求)</h3>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"k8s-etcd"</span>, </span><br><span class="line">    <span class="string">"hosts"</span>: [], </span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>, </span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>, </span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>, </span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>, </span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"K8s"</span>, </span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ], </span><br><span class="line">    <span class="string">"ca"</span>: &#123;</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p><strong>字段说明：</strong></p>
<ul>
<li><code>CN</code>：浏览器使用该字段验证网站是否合法，一般写的是域名，非常重要</li>
<li><code>C</code>：国家</li>
<li><code>ST</code>：州/省</li>
<li><code>L</code>：地区/城市</li>
<li><code>O</code>：组织名称/公司名称</li>
<li><code>OU</code>：组织单位名称，公司部门</li>
</ul>
</blockquote>

        <h3 id="3-3-3-生成ca-pem-ca-key-pem"   >
          <a href="#3-3-3-生成ca-pem-ca-key-pem" class="heading-link"><i class="fas fa-link"></i></a>3.3.3 生成ca.pem/ca-key.pem</h3>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ssl]<span class="comment"># cfssl gencert -initca ca-csr.json | cfssl-json -bare ca</span></span><br><span class="line">2020/11/03 13:41:02 [INFO] generating a new CA key and certificate from CSR</span><br><span class="line">2020/11/03 13:41:02 [INFO] generate received request</span><br><span class="line">2020/11/03 13:41:02 [INFO] received CSR</span><br><span class="line">2020/11/03 13:41:02 [INFO] generating key: rsa-2048</span><br><span class="line">2020/11/03 13:41:03 [INFO] encoded CSR</span><br><span class="line">2020/11/03 13:41:03 [INFO] signed certificate with serial number 505960618619177184024699756202702165923949526692</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果命令执行错误，则需要检查json文件</span></span><br><span class="line"></span><br><span class="line">[root@harbor ssl]<span class="comment"># ls</span></span><br><span class="line">ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p><code>ca-csr.json</code>  # 请求文件<br><code>ca-key.pem</code> # 证书<br><code>ca.csr</code><br><code>ca.pem</code>  # 证书<br><code>ca-config.json</code>  # CA配置文件</p>
</blockquote>

        <h2 id="3-4-创建etcd-pem和etcd-key-pem"   >
          <a href="#3-4-创建etcd-pem和etcd-key-pem" class="heading-link"><i class="fas fa-link"></i></a>3.4 创建etcd.pem和etcd-key.pem</h2>
      
        <h3 id="3-4-1-etcd证书申请表"   >
          <a href="#3-4-1-etcd证书申请表" class="heading-link"><i class="fas fa-link"></i></a>3.4.1 etcd证书申请表</h3>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; etcd-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"etcd"</span>, </span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">        <span class="string">"127.0.0.1"</span>, </span><br><span class="line">        <span class="string">"192.168.1.53"</span>, </span><br><span class="line">        <span class="string">"192.168.1.61"</span>, </span><br><span class="line">        <span class="string">"192.168.1.62"</span></span><br><span class="line">    ], </span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>, </span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>, </span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>, </span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>, </span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"k8s"</span>, </span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>hosts 字段分别指定了etcd集群(192.168.1.53, 192.168.1.61, 192.168.1.62)</p>
</blockquote>

        <h3 id="3-4-2-生成etcd-pem-etcd-key-pem"   >
          <a href="#3-4-2-生成etcd-pem-etcd-key-pem" class="heading-link"><i class="fas fa-link"></i></a>3.4.2 生成etcd.pem/etcd-key.pem</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-csr.json | cfssl-json -bare etcd2020/11/03 13:47:04 [INFO] generate received request</span><br><span class="line">2020/11/03 13:47:04 [INFO] received CSR</span><br><span class="line">2020/11/03 13:47:04 [INFO] generating key: rsa-2048</span><br><span class="line">2020/11/03 13:47:05 [INFO] encoded CSR</span><br><span class="line">2020/11/03 13:47:05 [INFO] signed certificate with serial number 729877808570657709802169738116069958436033138313</span><br><span class="line">2020/11/03 13:47:05 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 ("Information Requirements").</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>注：因为是对等证书，需要指定hosts（即只能在指定的IP上使用）；hosts指定的IP均为etcd各节点的IP<br>参数说明：<br><code>-ca=ca.pem</code>  # CA证书<br><code>-ca-key=ca-key.pem</code>  # CA证书<br><code>-config=ca-config.json</code>  # CA配置文件<br><code>-profile=peer</code>  # 这个peer是指ca-config.json文件里的profiles<br><code>etcd-csr.json</code>  # etcd配置文件</p>
</blockquote>

        <h2 id="3-5-创建apiserver-pem和apiserver-key-pem"   >
          <a href="#3-5-创建apiserver-pem和apiserver-key-pem" class="heading-link"><i class="fas fa-link"></i></a>3.5 创建apiserver.pem和apiserver-key.pem</h2>
      
        <h3 id="3-5-1-k8s-apiserver证书申请表"   >
          <a href="#3-5-1-k8s-apiserver证书申请表" class="heading-link"><i class="fas fa-link"></i></a>3.5.1 k8s-apiserver证书申请表</h3>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; apiserver-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"k8s-apiserver"</span>, </span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">        <span class="string">"192.168.80.1"</span>, </span><br><span class="line">        <span class="string">"127.0.0.1"</span>, </span><br><span class="line">        <span class="string">"kubernetes"</span>, </span><br><span class="line">        <span class="string">"kubernetes.default"</span>, </span><br><span class="line">        <span class="string">"kubernetes.default.svc"</span>, </span><br><span class="line">        <span class="string">"kubernetes.default.svc.cluster"</span>, </span><br><span class="line">        <span class="string">"kubernetes.default.svc.cluster.local"</span>, </span><br><span class="line">        <span class="string">"192.168.1.50"</span>, </span><br><span class="line">        <span class="string">"192.168.1.51"</span>, </span><br><span class="line">        <span class="string">"192.168.1.52"</span>, </span><br><span class="line">        <span class="string">"192.168.1.53"</span>, </span><br><span class="line">        <span class="string">"192.168.1.54"</span>, </span><br><span class="line">        <span class="string">"192.168.1.55"</span>, </span><br><span class="line">        <span class="string">"192.168.1.59"</span>, </span><br><span class="line">        <span class="string">"192.168.1.61"</span>,</span><br><span class="line">        <span class="string">"192.168.1.62"</span>,</span><br><span class="line">        <span class="string">"192.168.1.63"</span></span><br><span class="line">    ], </span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>, </span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>, </span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>, </span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>, </span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"k8s"</span>, </span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>
<blockquote>
<ul>
<li><strong>字段说明：</strong></li>
<li><code>hosts</code>：指定授权使用该证书的 IP 或域名列表，这里列出了<code>VIP</code>、<code>apiserver节点 IP</code>、<code>kubernetes 服务 IP</code>和<code>域名</code>；</li>
<li>域名最后字符不能是 <code>kubernetes.default.svc.cluster.local.</code> (如为<code>kubernetes.default.svc.cluster.local</code> )，否则解析时失败，提示： <code>x509:cannot parse dnsName &quot;kubernetes.default.svc.cluster.local.&quot;</code> ；如果使用非 <code>cluster.local</code> 域名，如 <code>jeremy.com</code> ，则需要修改域名列表中的最后两个域名为： <code>kubernetes.default.svc.jeremy</code> 、 <code>kubernetes.default.svc.jeremy.com</code></li>
<li>kubernetes 服务 IP 是 apiserver 自动创建的，一般是 <code>--service-cluster-ip-range</code> 参数指定的网段的第一个IP，如：<code>192.168.80.1</code>，可以通过如下命令获取：<code>kubectl get svc kubernetes</code></li>
</ul>
</blockquote>

        <h3 id="3-5-2-生成apiserver-pem-apiserver-key-pem"   >
          <a href="#3-5-2-生成apiserver-pem-apiserver-key-pem" class="heading-link"><i class="fas fa-link"></i></a>3.5.2 生成apiserver.pem/apiserver-key.pem</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server apiserver-csr.json | cfssl-json -bare apiserver</span><br><span class="line">2020/11/04 10:58:41 [INFO] generate received request</span><br><span class="line">2020/11/04 10:58:41 [INFO] received CSR</span><br><span class="line">2020/11/04 10:58:41 [INFO] generating key: rsa-2048</span><br><span class="line">2020/11/04 10:58:41 [INFO] encoded CSR</span><br><span class="line">2020/11/04 10:58:41 [INFO] signed certificate with serial number 417200226383473750655800122540809938117557321843</span><br><span class="line">2020/11/04 10:58:41 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 ("Information Requirements").</span><br></pre></td></tr></table></div></figure>


        <h2 id="3-6-创建client证书"   >
          <a href="#3-6-创建client证书" class="heading-link"><i class="fas fa-link"></i></a>3.6 创建client证书</h2>
      
        <h3 id="3-6-1-client证书申请表"   >
          <a href="#3-6-1-client证书申请表" class="heading-link"><i class="fas fa-link"></i></a>3.6.1 client证书申请表</h3>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; client-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"k8s-node"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [ ],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>, </span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>, </span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>, </span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>, </span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"k8s"</span>, </span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-6-2-生成client-pem-client-key-pem"   >
          <a href="#3-6-2-生成client-pem-client-key-pem" class="heading-link"><i class="fas fa-link"></i></a>3.6.2 生成client.pem/client-key.pem</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client client-csr.json | cfssl-json -bare client</span><br><span class="line">2020/11/04 11:06:55 [INFO] generate received request</span><br><span class="line">2020/11/04 11:06:55 [INFO] received CSR</span><br><span class="line">2020/11/04 11:06:55 [INFO] generating key: rsa-2048</span><br><span class="line">2020/11/04 11:06:56 [INFO] encoded CSR</span><br><span class="line">2020/11/04 11:06:56 [INFO] signed certificate with serial number 222013183583544520725975954747262666137293405239</span><br><span class="line">2020/11/04 11:06:56 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 ("Information Requirements").</span><br></pre></td></tr></table></div></figure>


        <h2 id="3-7-创建kubelet证书"   >
          <a href="#3-7-创建kubelet证书" class="heading-link"><i class="fas fa-link"></i></a>3.7 创建kubelet证书</h2>
      <blockquote>
<p>在本实例中没有用上</p>
</blockquote>

        <h3 id="3-7-1-kubelet证书申请表"   >
          <a href="#3-7-1-kubelet证书申请表" class="heading-link"><i class="fas fa-link"></i></a>3.7.1 kubelet证书申请表</h3>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kubelet-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"k8s-kubelet"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">        <span class="string">"127.0.0.1"</span>,</span><br><span class="line">        <span class="string">"192.168.1.50"</span>, </span><br><span class="line">        <span class="string">"192.168.1.61"</span>,</span><br><span class="line">        <span class="string">"192.168.1.62"</span>,</span><br><span class="line">        <span class="string">"192.168.1.63"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>, </span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>, </span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>, </span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"k8s"</span>, </span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-7-2-生成kubelet证书和私钥"   >
          <a href="#3-7-2-生成kubelet证书和私钥" class="heading-link"><i class="fas fa-link"></i></a>3.7.2 生成kubelet证书和私钥</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server kubelet-csr.json | cfssl-json -bare kubelet</span><br><span class="line">2020/11/08 09:39:09 [INFO] generate received request</span><br><span class="line">2020/11/08 09:39:09 [INFO] received CSR</span><br><span class="line">2020/11/08 09:39:09 [INFO] generating key: rsa-2048</span><br><span class="line">2020/11/08 09:39:10 [INFO] encoded CSR</span><br><span class="line">2020/11/08 09:39:10 [INFO] signed certificate with serial number 619612250475747667662866728368259285104382786974</span><br><span class="line">2020/11/08 09:39:10 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 ("Information Requirements").</span><br></pre></td></tr></table></div></figure>


        <h2 id="3-8-创建kube-proxy证书"   >
          <a href="#3-8-创建kube-proxy证书" class="heading-link"><i class="fas fa-link"></i></a>3.8 创建kube-proxy证书</h2>
      
        <h3 id="3-8-1-kube-proxy证书申请表"   >
          <a href="#3-8-1-kube-proxy证书申请表" class="heading-link"><i class="fas fa-link"></i></a>3.8.1 kube-proxy证书申请表</h3>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-proxy-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>, </span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>, </span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>, </span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>, </span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"k8s"</span>, </span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-8-2-生成kube-proxy证书和私钥"   >
          <a href="#3-8-2-生成kube-proxy证书和私钥" class="heading-link"><i class="fas fa-link"></i></a>3.8.2 生成kube-proxy证书和私钥</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer kube-proxy-csr.json | cfssl-json -bare kube-proxy</span><br><span class="line">2020/11/10 17:37:33 [INFO] generate received request</span><br><span class="line">2020/11/10 17:37:33 [INFO] received CSR</span><br><span class="line">2020/11/10 17:37:33 [INFO] generating key: rsa-2048</span><br><span class="line">2020/11/10 17:37:34 [INFO] encoded CSR</span><br><span class="line">2020/11/10 17:37:34 [INFO] signed certificate with serial number 90775656677340076756991108231339958260961996104</span><br><span class="line">2020/11/10 17:37:34 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 ("Information Requirements").</span><br></pre></td></tr></table></div></figure>



        <h1 id="4-Etcd集群部署"   >
          <a href="#4-Etcd集群部署" class="heading-link"><i class="fas fa-link"></i></a>4. Etcd集群部署</h1>
      <ul>
<li>k8s-master1：<code>192.168.1.53</code><ul>
<li>etcd</li>
</ul>
</li>
<li>k8s-node1：<code>192.168.1.61</code><ul>
<li>etcd</li>
</ul>
</li>
<li>k8s-node2：<code>192.168.1.62</code><ul>
<li>etcd</li>
</ul>
</li>
</ul>

        <h2 id="4-1-安装"   >
          <a href="#4-1-安装" class="heading-link"><i class="fas fa-link"></i></a>4.1 安装</h2>
      <p><span class="exturl"><a class="exturl__link"   href="https://github.com/etcd-io/etcd/releases"  target="_blank" rel="noopener">github地址</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/etcd-io/etcd/releases/download/v3.4.13/etcd-v3.4.13-linux-amd64.tar.gz</span><br><span class="line">tar -xzvf etcd-v3.4.13-linux-amd64.tar.gz</span><br><span class="line">mkdir /opt/etcd/&#123;bin,conf.d,ssl,data&#125; -p</span><br><span class="line">mv etcd-v3.4.13-linux-amd64/&#123;etcd,etcdctl&#125; /opt/etcd/bin/</span><br></pre></td></tr></table></div></figure>


        <h2 id="4-2-创建证书"   >
          <a href="#4-2-创建证书" class="heading-link"><i class="fas fa-link"></i></a>4.2 创建证书</h2>
      <ul>
<li><p><strong>请看3.4 创建etcd.pem和etcd-key.pem</strong></p>
</li>
<li><p><strong>拷贝到<code>/opt/etcd/ssl</code></strong></p>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ssl]# scp &#123;ca,etcd,etcd-key&#125;.pem k8s-master1:/opt/etcd/ssl</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ssl]# ll</span><br><span class="line">total 12</span><br><span class="line">-rw-r--r-- 1 root root 1354 Nov  3 13:54 ca.pem</span><br><span class="line">-rw------- 1 root root 1679 Nov  3 13:54 etcd-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1432 Nov  3 13:54 etcd.pem</span><br></pre></td></tr></table></div></figure>

</li>
</ul>

        <h2 id="4-3-各etcd节点配置文件"   >
          <a href="#4-3-各etcd节点配置文件" class="heading-link"><i class="fas fa-link"></i></a>4.3 各etcd节点配置文件</h2>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/etcd/conf.d/etcd.conf &lt;&lt; EOF</span><br><span class="line"><span class="comment"># [Member]</span></span><br><span class="line">ETCD_NAME=<span class="string">"etcd-1"</span>    <span class="comment">#不同节点需要更改</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/opt/etcd/data"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://192.168.1.53:2380"</span>     <span class="comment">#不同节点需要更改</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://192.168.1.53:2379"</span>    <span class="comment">#不同节点需要更改</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># [Clustering]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://192.168.1.53:2380"</span>    <span class="comment">#不同节点需要更改</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://192.168.1.53:2379"</span>         <span class="comment">#不同节点需要更改</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd-1=https://192.168.1.53:2380,etcd-2=https://192.168.1.61:2380,etcd-3=https://192.168.1.62:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster-1"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *</span><br><span class="line"></span><br><span class="line">cat &gt; /opt/etcd/conf.d/etcd.conf &lt;&lt; EOF</span><br><span class="line"><span class="comment"># [Member]</span></span><br><span class="line">ETCD_NAME=<span class="string">"etcd-2"</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/opt/etcd/data"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://192.168.1.61:2380"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://192.168.1.61:2379"</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># [Clustering]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://192.168.1.61:2380"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://192.168.1.61:2379"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd-1=https://192.168.1.53:2380,etcd-2=https://192.168.1.61:2380,etcd-3=https://192.168.1.62:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster-1"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *</span><br><span class="line"></span><br><span class="line">cat &gt; /opt/etcd/conf.d/etcd.conf &lt;&lt; EOF</span><br><span class="line"><span class="comment">#[Member]</span></span><br><span class="line">ETCD_NAME=<span class="string">"etcd-3"</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/opt/etcd/data"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://192.168.1.62:2380"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://192.168.1.62:2379"</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#[Clustering]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://192.168.1.62:2380"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://192.168.1.62:2379"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd-1=https://192.168.1.53:2380,etcd-2=https://192.168.1.61:2380,etcd-3=https://192.168.1.62:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster-1"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p><strong>参数说明：</strong><br><code>ETCD_NAME</code>：节点名称，集群中唯一<br><code>ETCD_DATA_DIR</code>：数据目录<br><code>ETCD_LISTEN_PEER_URLS</code>：集群通信监听地址<br><code>ETCD_LISTEN_CLIENT_URLS</code>：客户端访问监听地址<br><code>ETCD_INITIAL_ADVERTISE_PEER_URLS</code>：集群通告地址<br><code>ETCD_ADVERTISE_CLIENT_URLS</code>：客户端通告地址<br><code>ETCD_INITIAL_CLUSTER</code>：集群节点地址<br><code>ETCD_INITIAL_CLUSTER_TOKEN</code>：集群Token<br><code>ETCD_INITIAL_CLUSTER_STATE</code>：加入集群的当前状态，<code>new</code>是新集群，<code>existing</code>表示加入已有集群</p>
</blockquote>

        <h2 id="4-4-systemd管理etcd"   >
          <a href="#4-4-systemd管理etcd" class="heading-link"><i class="fas fa-link"></i></a>4.4 systemd管理etcd</h2>
      <ul>
<li><p><strong>systemd文件</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;  /usr/lib/systemd/system/etcd.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/opt/etcd/conf.d/etcd.conf</span><br><span class="line">ExecStart=/opt/etcd/bin/etcd \\</span><br><span class="line">        --cert-file=/opt/etcd/ssl/peer.pem \\</span><br><span class="line">        --key-file=/opt/etcd/ssl/peer-key.pem \\</span><br><span class="line">        --peer-cert-file=/opt/etcd/ssl/peer.pem \\</span><br><span class="line">        --peer-key-file=/opt/etcd/ssl/peer-key.pem \\</span><br><span class="line">        --trusted-ca-file=/opt/etcd/ssl/ca.pem \\</span><br><span class="line">        --peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \\</span><br><span class="line">        --peer-client-cert-auth \\</span><br><span class="line">        --client-cert-auth \\</span><br><span class="line">        --<span class="built_in">log</span>-level=info \\</span><br><span class="line">        --logger=zap \\</span><br><span class="line">        --<span class="built_in">log</span>-outputs=stderr</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>
</li>
<li><p><strong>启动并设置开机启动</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start etcd</span><br><span class="line">systemctl <span class="built_in">enable</span> etcd</span><br></pre></td></tr></table></div></figure>


</li>
</ul>

        <h2 id="4-5-检查etcd集群节点健康情况"   >
          <a href="#4-5-检查etcd集群节点健康情况" class="heading-link"><i class="fas fa-link"></i></a>4.5 检查etcd集群节点健康情况</h2>
      <ul>
<li><strong>etcd各节点健康情况</strong><br><code>/opt/etcd/bin/etcdctl --endpoints=&quot;https://192.168.1.53:2379,https://192.168.1.61:2379,https://192.168.1.62:2379&quot; --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/etcd.pem --key=/opt/etcd/ssl/etcd-key.pem  endpoint health</code></li>
</ul>
<p><img src="/images/k8s-png/4.etcd%E5%90%84%E8%8A%82%E7%82%B9%E5%81%A5%E5%BA%B7%E6%83%85%E5%86%B5.png" alt="4.etcd各节点健康情况.png"></p>
<ul>
<li><strong>etcd各节点状态情况</strong><br><code>/opt/etcd/bin/etcdctl --endpoints=&quot;https://192.168.1.53:2379,https://192.168.1.61:2379,https://192.168.1.62:2379&quot; --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/etcd.pem --key=/opt/etcd/ssl/etcd-key.pem  endpoint status --write-out=table</code></li>
</ul>
<p><img src="/images/k8s-png/5.etcd%E5%90%84%E8%8A%82%E7%82%B9%E7%8A%B6%E6%80%81%E6%83%85%E5%86%B5.png" alt="5.etcd各节点状态情况.png"></p>

        <h1 id="5-Docker部署"   >
          <a href="#5-Docker部署" class="heading-link"><i class="fas fa-link"></i></a>5. Docker部署</h1>
      <ol>
<li><strong>下载地址</strong></li>
</ol>
<p><span class="exturl"><a class="exturl__link"   href="https://download.docker.com/linux/static/stable/x86_64/docker-19.03.9.tgz"  target="_blank" rel="noopener">docker-19.03.9下载地址</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<blockquote>
<p>下载放到<code>/opt</code>目录下</p>
</blockquote>
<ol start="2">
<li><strong>安装</strong></li>
</ol>
<p>只为node节点和harbor部署安装docker (node1, node2, harbor)</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tar -xzvf docker-19.03.9.tgz</span><br><span class="line"></span><br><span class="line">mkdir /opt/docker/bin</span><br><span class="line">mv /opt/docker/* /opt/docker/bin</span><br><span class="line"></span><br><span class="line">ln -sv /opt/docker/docker /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">ln -sv /opt/docker/containerd /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">ln -sv /opt/docker/containerd-shim /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">ln -sv /opt/docker/ctr /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">ln -sv /opt/docker/dockerd /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">ln -sv /opt/docker/docker-init /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">ln -sv /opt/docker/docker-proxy /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">ln -sv /opt/docker/runc /usr/<span class="built_in">local</span>/bin/</span><br></pre></td></tr></table></div></figure>

<ol start="3">
<li><p><strong>systemd管理docker</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/docker.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/dockerd</span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -s HUP \<span class="variable">$MAINPID</span></span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>
</li>
<li><p><strong>配置文件</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/docker/ </span><br><span class="line">mkdir -p /opt/docker/data</span><br><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"graph"</span>: <span class="string">"/opt/docker/data"</span>,</span><br><span class="line">  <span class="string">"storage-driver"</span>: <span class="string">"overlay2"</span>,</span><br><span class="line">  <span class="string">"insecure-registries"</span>: [<span class="string">"registry.access.redhat.com"</span>,<span class="string">"quay.io"</span>,<span class="string">"harbor.jeremy.cn"</span>],</span><br><span class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://b9pmyelo.mirror.aliyuncs.com"</span>],</span><br><span class="line">  <span class="string">"bip"</span>: <span class="string">"172.7.53.1/24"</span>,</span><br><span class="line">  <span class="string">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=cgroupfs"</span>],</span><br><span class="line">  <span class="string">"live-restore"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

</li>
</ol>
<blockquote>
<p><code>bip</code>：<code>172.7.x.1/24</code>，x按照宿主机IP地址最后一位来设置<br><code>insecure-registries</code>：需要添加你harbor的域名，不然harbor无法登录</p>
</blockquote>
<ol start="5">
<li><strong>启动docker</strong><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload </span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line">systemctl status docker</span><br></pre></td></tr></table></div></figure>

</li>
</ol>

        <h1 id="6-Harbor部署"   >
          <a href="#6-Harbor部署" class="heading-link"><i class="fas fa-link"></i></a>6. Harbor部署</h1>
      <ol>
<li><strong>下载地址</strong></li>
</ol>
<p><span class="exturl"><a class="exturl__link"   href="https://github.com/goharbor/harbor/releases/download/v2.1.1/harbor-offline-installer-v2.1.1.tgz"  target="_blank" rel="noopener">下载地址</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<ol start="2">
<li><strong>校验</strong></li>
</ol>
<p>下载对应版本的检验码进行校验：<br><span class="exturl"><a class="exturl__link"   href="https://github.com/goharbor/harbor/releases/download/v2.1.1/md5sum"  target="_blank" rel="noopener">v2.1.1校验码</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>然后使用 <code>md5sum -c md5sum</code> 来查看文件内容是否正确，如果正确，会显示下面的内容。</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor opt]# md5sum -c md5sum</span><br><span class="line">harbor-offline-installer-v2.1.1.tgz: OK</span><br></pre></td></tr></table></div></figure>
<blockquote>
<p>如果你下载是<code>harbor-offline-installer-v2.1.1.tgz</code>，则这个才会显示ok；<br>而没下载的例如：<code>harbor-online-installer-v2.1.1.tgz</code>，则会提示<code>md5sum: harbor-online-installer-v2.1.1.tgz: No such file or directory</code></p>
</blockquote>
<ol start="3">
<li><strong>解压</strong></li>
</ol>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tar -xzvf harbor-offline-installer-v2.1.1.tgz</span><br><span class="line"></span><br><span class="line">harbor/harbor.v2.1.1.tar.gz</span><br><span class="line">harbor/prepare</span><br><span class="line">harbor/LICENSE</span><br><span class="line">harbor/install.sh</span><br><span class="line">harbor/common.sh</span><br><span class="line">harbor/harbor.yml.tmpl</span><br></pre></td></tr></table></div></figure>

<ol start="4">
<li><strong>配置文件</strong></li>
</ol>
<blockquote>
<p><code>harbor.yml.tmpl</code> 这个文件配置文件模板，可以按其格式来<br>去掉注释：<code>grep -v &quot;#&quot; harbor.yml.tmpl</code></p>
</blockquote>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/harbor/</span><br><span class="line">vim harbor.yml</span><br><span class="line"></span><br><span class="line">hostname: harbor.jeremy.cn</span><br><span class="line">http:</span><br><span class="line">  port: 8080</span><br><span class="line">harbor_admin_password: Harbor12345</span><br><span class="line">database:</span><br><span class="line">  password: root123</span><br><span class="line">  max_idle_conns: 50</span><br><span class="line">  max_open_conns: 1000</span><br><span class="line">data_volume: /opt/harborData</span><br><span class="line">clair:</span><br><span class="line">  updaters_interval: 12</span><br><span class="line">trivy:</span><br><span class="line">  ignore_unfixed: <span class="literal">false</span></span><br><span class="line">  skip_update: <span class="literal">false</span></span><br><span class="line">  insecure: <span class="literal">false</span></span><br><span class="line">jobservice:</span><br><span class="line">  max_job_workers: 10</span><br><span class="line">notification:</span><br><span class="line">  webhook_job_max_retry: 10</span><br><span class="line">chart:</span><br><span class="line">  absolute_url: disabled</span><br><span class="line"><span class="built_in">log</span>:</span><br><span class="line">  level: info</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    rotate_count: 50</span><br><span class="line">    rotate_size: 200M</span><br><span class="line">    location: /opt/harborData/logs</span><br><span class="line">_version: 2.0.0</span><br><span class="line">proxy:</span><br><span class="line">  http_proxy:</span><br><span class="line">  https_proxy:</span><br><span class="line">  no_proxy:</span><br><span class="line">  components:</span><br><span class="line">    - core</span><br><span class="line">    - jobservice</span><br><span class="line">    - clair</span><br><span class="line">    - trivy</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p><strong>参数说明：</strong><br>一般情况下，我们最少需要配置的内容如下：</p>
<ul>
<li><code>hostname</code> 需要配置为 127.0.0.1 之外的内容，以提供外部访问</li>
<li><code>https</code> 的配置需要同时配置证书，生产环境中，如果使用 SLB 或者使用其他应用统一提供 SSL 接入，则可以删除。</li>
<li><code>harbor_admin_password</code> 默认密码即可，但是初次使用登陆后台后需要修改密码。</li>
<li><code>data_volume</code> 根据自己实际情况修改宿主机的文件储存地址。</li>
</ul>
</blockquote>
<ol start="5">
<li><p><strong>创建harbor数据存储目录</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/harborData</span><br><span class="line">mkdir -p  /opt/harborData/logs</span><br></pre></td></tr></table></div></figure>
</li>
<li><p><strong>安装docker-compose</strong></p>
</li>
</ol>
<p><code>curl -L &quot;https://github.com/docker/compose/releases/download/1.27.4/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</code></p>
<p><code>chmod +x /usr/local/bin/docker-compose</code></p>
<ol start="7">
<li><strong>安装harbor</strong></li>
</ol>
<p>修改完配置之后，使用 <code>bash install.sh</code> 进行应用安装。</p>
<p><code>sh /opt/harbor/install.sh</code></p>
<ul>
<li>用docker-compose查看</li>
</ul>
<p><img src="/images/k8s-png/6.harbor-%E7%94%A8docker-compose%E6%9F%A5%E7%9C%8B.png" alt="6.harbor-用docker-compose查看.png"></p>
<ol start="8">
<li><strong>安装nginx</strong></li>
</ol>
<ul>
<li><p><code>yum install nginx -y</code></p>
</li>
<li><p><code>vim /etc/nginx/conf.d/harbor.conf</code></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  harbor.jeremy.cn;</span><br><span class="line">    client_max_body_size 1000m;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://127.0.0.1:8080;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</li>
<li><p><strong>启动nginx</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start nginx</span><br><span class="line">systemctl <span class="built_in">enable</span> nginx</span><br><span class="line">systemctl status nginx</span><br></pre></td></tr></table></div></figure>
</li>
</ul>
<ol start="9">
<li><strong>添加dns记录</strong></li>
</ol>
<ul>
<li><code>vim /var/named/jeremy.cn.zone</code></li>
</ul>
<p><img src="/images/k8s-png/7.harbor-%E6%B7%BB%E5%8A%A0dns%E8%AE%B0%E5%BD%95.png" alt="7.harbor-添加dns记录.png"></p>
<ul>
<li><p>重启<br><code>systemctl restart named</code></p>
</li>
<li><p>测试<br><code>dig -t A harbor.jeremy.cn +short</code></p>
</li>
</ul>
<ol start="10">
<li><strong>上传镜像</strong></li>
</ol>
<ul>
<li><p><strong>访问<code>http://harbor.jeremy.cn/</code></strong><br><img src="/images/k8s-png/8.%E8%AE%BF%E9%97%AEharbor.png" alt="8.访问harbor.png"></p>
</li>
<li><p><strong>添加一个<code>public</code>库</strong><br><img src="/images/k8s-png/9.%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AApublic%E5%BA%93.png" alt="9.添加一个public库.png"></p>
</li>
<li><p><strong>拉取</strong><br>docker pull nginx</p>
</li>
</ul>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor harbor]# docker images</span><br><span class="line">REPOSITORY                      TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">nginx                           latest              c39a868aad02        33 hours ago        133MB</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p><strong>打tag</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag c39a868aad02 harbor.jeremy.cn/public/nginx:latest</span><br></pre></td></tr></table></div></figure>
</li>
<li><p><strong>登录</strong></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor harbor]# docker login harbor.jeremy.cn </span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></div></figure>

</li>
</ul>
<blockquote>
<p>要登陆的需要在<code>/etc/docker/daemon.json</code> 里面的 <code>insecure-registries</code> 添加harbor的域名(harbor.jeremy.cn)，不然无法使用http登录，https登录则需要配置中有https<br>如果之前的docker配置没有添加harbor的域名，则需要重新打包运行harbor，不然还是登录不了</p>
</blockquote>
<ul>
<li><strong>推送镜像到harbor</strong><figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor harbor]# docker push harbor.jeremy.cn/public/nginx:latest</span><br><span class="line">The push refers to repository [harbor.jeremy.cn/public/nginx]</span><br><span class="line">7b5417cae114: Pushed </span><br><span class="line">aee208b6ccfb: Pushed </span><br><span class="line">2f57e21e4365: Pushed </span><br><span class="line">2baf69a23d7a: Pushed </span><br><span class="line">d0fe97fa8b8c: Pushed </span><br><span class="line">latest: digest: sha256:34f3f875e745861ff8a37552ed7eb4b673544d2c56c7cc58f9a9bec5b4b3530e size: 1362</span><br></pre></td></tr></table></div></figure>


</li>
</ul>

        <h1 id="7-Master节点部署"   >
          <a href="#7-Master节点部署" class="heading-link"><i class="fas fa-link"></i></a>7. Master节点部署</h1>
      <blockquote>
<p><code>kube-apiserver</code>是Kubernetes最重要的核心组件之一，主要提供以下的功能：</p>
<ul>
<li>提供集群管理的REST API接口，包括认证授权、数据校验以及集群状态变更等</li>
<li>提供其他模块之间的数据交互和通信的枢纽(其他模块通过API Server查询或修改数据，只有API Server才直接操作etcd)。</li>
</ul>
</blockquote>
<ul>
<li>k8s-master1：<code>192.168.1.53</code><ul>
<li>kube-apiserver</li>
<li>kube-controller-manager</li>
<li>kube-scheduler</li>
<li>etcd</li>
</ul>
</li>
<li>k8s-master2：<code>192.168.1.54</code><ul>
<li>kube-apiserver</li>
<li>kube-controller-manager</li>
<li>kube-scheduler</li>
</ul>
</li>
</ul>

        <h2 id="7-1-kube-apiserver部署"   >
          <a href="#7-1-kube-apiserver部署" class="heading-link"><i class="fas fa-link"></i></a>7.1 kube-apiserver部署</h2>
      <ol>
<li><strong>下载地址</strong></li>
</ol>
<p><span class="exturl"><a class="exturl__link"   href="https://github.com/kubernetes/kubernetes/"  target="_blank" rel="noopener">kubernetes GitHub地址</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<ul>
<li>从Github下载二进制文件<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">下载地址： https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.18.md#v1183</span><br><span class="line"></span><br><span class="line">注：打开链接你会发现里面有很多包，下载一个server包就够了，包含了Master和Worker Node二进制文件。</span><br></pre></td></tr></table></div></figure>

</li>
</ul>
<p><strong>1.18.10版本</strong>：<code>wget https://storage.googleapis.com/kubernetes-release/release/v1.18.10/kubernetes-server-linux-amd64.tar.gz</code></p>
<ol start="2">
<li><strong>解压和创建文件夹</strong></li>
</ol>
<p>分别在两台master上下载kubernetes-server-linux-amd64.tar.gz</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -xzvf kubernetes-server-linux-amd64.tar.gz -C /opt</span><br><span class="line">mkdir /opt/kubernetes/server/&#123;cert,conf.d,logs&#125;</span><br></pre></td></tr></table></div></figure>
<blockquote>
<p>/opt/kubernetes/server/cert：存放证书<br>/opt/kubernetes/server/conf：存放启动配置文件</p>
</blockquote>
<ol start="3">
<li><strong>创建证书</strong></li>
</ol>
<ul>
<li><strong>查看 3.5 创建apiserver.pem和apiserver-key.pem</strong></li>
</ul>
<ol start="4">
<li><strong>拷贝证书</strong></li>
</ol>
<p><code>[root@harbor ssl]# scp /root/ssl/{ca.pem,ca-key.pem,apiserver.pem,apiserver-key.pem,client.pem,client-key.pem}  k8s-master1:/opt/kubernetes/server/cert</code></p>
<p><code>[root@harbor ssl]# scp /root/ssl/{ca.pem,ca-key.pem,apiserver.pem,apiserver-key.pem,client.pem,client-key.pem}  k8s-master2:/opt/kubernetes/server/cert</code></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 server]# ll cert/</span><br><span class="line">total 24</span><br><span class="line">-rw------- 1 root root 1679 Nov  4 14:02 apiserver-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1671 Nov  4 14:02 apiserver.pem</span><br><span class="line">-rw------- 1 root root 1671 Nov  4 14:02 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1354 Nov  4 14:02 ca.pem</span><br><span class="line">-rw------- 1 root root 1675 Nov  4 14:02 client-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1375 Nov  4 14:02 client.pem</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>注意私钥文件属性600</p>
</blockquote>
<ol start="5">
<li><strong>启用 TLS Bootstrapping 机制</strong></li>
</ol>
<blockquote>
<p><strong>TLS Bootstraping</strong>：<code>Master apiserver</code>启用TLS认证后，<code>Node</code>节点<code>kubelet</code>和<code>kube-proxy</code>要与<code>kube-apiserver</code>进行通信，必须使用<code>CA</code>签发的有效证书才可以，当<code>Node</code>节点很多时，这种客户端证书颁发需要大量工作，同样也会增加集群扩展复杂度。为了简化流程，<code>Kubernetes</code>引入了<code>TLS bootstraping</code>机制来自动颁发客户端证书，<code>kubelet</code>会以一个低权限用户自动向<code>apiserver</code>申请证书，<code>kubelet</code>的证书由<code>apiserver</code>动态签署。所以强烈建议在<code>Node</code>上使用这种方式，目前主要用于<code>kubelet</code>，<code>kube-proxy</code>还是由我们统一颁发一个证书。</p>
</blockquote>
<ul>
<li><strong><code>TLS bootstraping</code> 工作流程：</strong></li>
</ul>
<p>![10.TLS bootstraping 工作流程.png](/images/k8s-png/10.TLS bootstraping 工作流程.png)</p>
<p><strong># 1. 生成token</strong></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 server]# head -c 16 /dev/urandom | od -An -t x | tr -d ' '</span><br><span class="line">68b1ebf648614412dedc47208d3a45cf</span><br></pre></td></tr></table></div></figure>

<p><strong># 2. 创建上述配置文件中token文件</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/server/conf.d/token.csv &lt;&lt; EOF</span><br><span class="line">68b1ebf648614412dedc47208d3a45cf,kubelet-bootstrap,10001,<span class="string">"system:node-bootstrapper"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">格式：token，用户名，UID，用户组</span><br></pre></td></tr></table></div></figure>


<ol start="6">
<li><strong>创建配置文件</strong></li>
</ol>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/server/conf.d/kube-apiserver.conf &lt;&lt; EOF</span><br><span class="line">KUBE_APISERVER_OPTS=<span class="string">"--service-cluster-ip-range=192.168.80.0/24 \\</span></span><br><span class="line"><span class="string">    --service-node-port-range=30000-45535 \\</span></span><br><span class="line"><span class="string">    --apiserver-count=2 \\</span></span><br><span class="line"><span class="string">    --advertise-address=192.168.1.53 \\</span></span><br><span class="line"><span class="string">    --bind-address=0.0.0.0 \\</span></span><br><span class="line"><span class="string">    --secure-port=6443 \\</span></span><br><span class="line"><span class="string">    --authorization-mode=RBAC,Node \\</span></span><br><span class="line"><span class="string">    --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \\</span></span><br><span class="line"><span class="string">    --allow-privileged=true \\</span></span><br><span class="line"><span class="string">    --enable-bootstrap-token-auth=true \\</span></span><br><span class="line"><span class="string">    --token-auth-file=/opt/kubernetes/server/conf.d/token.csv \\</span></span><br><span class="line"><span class="string">    --etcd-cafile=/opt/kubernetes/server/cert/ca.pem \\</span></span><br><span class="line"><span class="string">    --etcd-certfile=/opt/kubernetes/server/cert/etcd.pem \\</span></span><br><span class="line"><span class="string">    --etcd-keyfile=/opt/kubernetes/server/cert/etcd-key.pem \\</span></span><br><span class="line"><span class="string">    --etcd-servers=https://192.168.1.53:2379,https://192.168.1.61:2379,https://192.168.1.62:2379 \\</span></span><br><span class="line"><span class="string">    --kubelet-client-certificate=/opt/kubernetes/server/cert/client.pem \\</span></span><br><span class="line"><span class="string">    --kubelet-client-key=/opt/kubernetes/server/cert/client-key.pem \\</span></span><br><span class="line"><span class="string">    --tls-cert-file=/opt/kubernetes/server/cert/apiserver.pem \\</span></span><br><span class="line"><span class="string">    --tls-private-key-file=/opt/kubernetes/server/cert/apiserver-key.pem \\</span></span><br><span class="line"><span class="string">    --service-account-key-file=/opt/kubernetes/server/cert/ca-key.pem \\</span></span><br><span class="line"><span class="string">    --client-ca-file=/opt/kubernetes/server/cert/ca.pem \\</span></span><br><span class="line"><span class="string">    --requestheader-client-ca-file=/opt/kubernetes/server/cert/ca.pem \\</span></span><br><span class="line"><span class="string">    --target-ram-mb=1024 \\</span></span><br><span class="line"><span class="string">    --audit-log-path=/opt/kubernetes/server/logs/apiserver.log \\</span></span><br><span class="line"><span class="string">    --audit-log-maxsize=100 \\</span></span><br><span class="line"><span class="string">    --audit-log-maxbackup=3 \\</span></span><br><span class="line"><span class="string">    --audit-log-maxage=30 \\</span></span><br><span class="line"><span class="string">    --event-ttl=1h \\</span></span><br><span class="line"><span class="string">    --logtostderr=false \\</span></span><br><span class="line"><span class="string">    --log-dir=/opt/kubernetes/server/logs \\</span></span><br><span class="line"><span class="string">    --v=2"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>注意修改 <code>--advertise-address=</code> 的地址，地址为master的ip</p>
</blockquote>
<ol start="7">
<li><strong>systemd管理apiserver</strong></li>
</ol>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/server/kube-apiserver.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/server/conf.d/kube-apiserver.conf</span><br><span class="line">ExecStart=/opt/kubernetes/server/bin/kube-apiserver \<span class="variable">$KUBE_APISERVER_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<p><code>cp /opt/kubernetes/server/kube-apiserver.service /usr/lib/systemd/system/</code></p>
<ol start="8">
<li><p><strong>启动并设置开机启动</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-apiserver</span><br><span class="line">systemctl <span class="built_in">enable</span> kube-apiserver</span><br><span class="line">systemctl status kube-apiserver</span><br></pre></td></tr></table></div></figure>
</li>
<li><p><strong>授权kubelet-bootstrap用户允许请求证书</strong></p>
</li>
</ol>
<p><code>kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap</code></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 kubernetes]# kubectl create clusterrolebinding kubelet-bootstrap \</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> --clusterrole=system:node-bootstrapper \</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> --user=kubelet-bootstrap</span></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/kubelet-bootstrap created</span><br></pre></td></tr></table></div></figure>



        <h2 id="7-2-kube-controller-manager部署"   >
          <a href="#7-2-kube-controller-manager部署" class="heading-link"><i class="fas fa-link"></i></a>7.2 kube-controller-manager部署</h2>
      <blockquote>
<p>Controller Manager是Kubernetes最重要的核心组件之一，主要提供以下的功能：</p>
<ul>
<li>主要kube-controller-manager和cloud-controller-manager组成，是Kubernetes的大脑，它通过apiserver监控整个集群的状态，并确保集群处于预期的工作状态。</li>
</ul>
</blockquote>
<ol>
<li><strong>创建配置文件</strong></li>
</ol>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/server/conf.d/kube-controller-manager.conf &lt;&lt; EOF</span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS=<span class="string">"--cluster-cidr=192.90.0.0/16 \\</span></span><br><span class="line"><span class="string">    --leader-elect=true \\</span></span><br><span class="line"><span class="string">    --master=127.0.0.1:8080 \\</span></span><br><span class="line"><span class="string">    --bind-address=127.0.0.1 \\</span></span><br><span class="line"><span class="string">    --allocate-node-cidrs=true \\</span></span><br><span class="line"><span class="string">    --service-cluster-ip-range=192.168.80.0/24 \\</span></span><br><span class="line"><span class="string">    --cluster-signing-cert-file=/opt/kubernetes/server/cert/ca.pem \\</span></span><br><span class="line"><span class="string">    --cluster-signing-key-file=/opt/kubernetes/server/cert/ca-key.pem  \\</span></span><br><span class="line"><span class="string">    --root-ca-file=/opt/kubernetes/server/cert/ca.pem \\</span></span><br><span class="line"><span class="string">    --service-account-private-key-file=/opt/kubernetes/server/cert/ca-key.pem \\</span></span><br><span class="line"><span class="string">    --experimental-cluster-signing-duration=87600h0m0s \\</span></span><br><span class="line"><span class="string">    --logtostderr=false \\</span></span><br><span class="line"><span class="string">    --log-dir=/opt/kubernetes/server/logs \\</span></span><br><span class="line"><span class="string">    --v=2"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<ol start="2">
<li><strong>systemd管理controller-manager</strong></li>
</ol>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/server/conf.d/kube-controller-manager.conf</span><br><span class="line">ExecStart=/opt/kubernetes/server/bin/kube-controller-manager \<span class="variable">$KUBE_CONTROLLER_MANAGER_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<ol start="3">
<li><strong>启动并设置开机启动</strong><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-controller-manager</span><br><span class="line">systemctl <span class="built_in">enable</span> kube-controller-manager</span><br><span class="line">systemctl status kube-controller-manager</span><br></pre></td></tr></table></div></figure>

</li>
</ol>

        <h2 id="7-3-kube-scheduler部署"   >
          <a href="#7-3-kube-scheduler部署" class="heading-link"><i class="fas fa-link"></i></a>7.3 kube-scheduler部署</h2>
      <blockquote>
<p>kube-scheduler是Kubernetes最重要的核心组件之一，主要提供以下的功能：</p>
<ul>
<li>负责分配调度Pod到集群内的节点上，它监听kube-apiserver，查询还未分配Node的Pod，然后根据调度策略为这些Pod分配节点(更新Pod的NodeName字段)。</li>
</ul>
</blockquote>
<ol>
<li><strong>创建配置文件</strong></li>
</ol>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/server/conf.d/kube-scheduler.conf &lt;&lt; EOF</span><br><span class="line">KUBE_SCHEDULER_OPTS=<span class="string">"--leader-elect=true \\</span></span><br><span class="line"><span class="string">    --master=127.0.0.1:8080 \\</span></span><br><span class="line"><span class="string">    --bind-address=127.0.0.1 \\</span></span><br><span class="line"><span class="string">    --log-dir=/opt/kubernetes/server/logs \\</span></span><br><span class="line"><span class="string">    --logtostderr=false \\</span></span><br><span class="line"><span class="string">    --v=2"</span> \\</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<ol start="2">
<li><strong>systemd管理scheduler</strong></li>
</ol>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/server/conf.d/kube-scheduler.conf</span><br><span class="line">ExecStart=/opt/kubernetes/server/bin/kube-scheduler \<span class="variable">$KUBE_SCHEDULER_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<ol start="3">
<li><strong>启动并设置开机启动</strong><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-scheduler</span><br><span class="line">systemctl <span class="built_in">enable</span> kube-scheduler</span><br><span class="line">systemctl status kube-scheduler</span><br></pre></td></tr></table></div></figure>

</li>
</ol>

        <h1 id="8-L4反向代理"   >
          <a href="#8-L4反向代理" class="heading-link"><i class="fas fa-link"></i></a>8. L4反向代理</h1>
      <ul>
<li>Load Balancer(Master)：<code>192.168.1.51</code>  -  <strong>192.168.1.50</strong>(VIP)<ul>
<li>Nginx L4</li>
</ul>
</li>
<li>Load Balancer(Backup)：<code>192.168.1.52</code><ul>
<li>Nginx L4</li>
</ul>
</li>
</ul>

        <h2 id="8-1-拓扑图"   >
          <a href="#8-1-拓扑图" class="heading-link"><i class="fas fa-link"></i></a>8.1 拓扑图</h2>
      <p><img src="/images/k8s-png/11.l4%E8%B4%9F%E8%BD%BD%E5%9B%BE.png" alt="11.l4负载图.png"></p>

        <h2 id="8-2-nginx部署"   >
          <a href="#8-2-nginx部署" class="heading-link"><i class="fas fa-link"></i></a>8.2 nginx部署</h2>
      <ol>
<li><p><strong>安装nginx</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install nginx -y</span><br></pre></td></tr></table></div></figure>
</li>
<li><p><strong>nginx配置文件</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/nginx/nginx.conf <span class="comment"># 黏贴到http标签外</span></span><br><span class="line">stream &#123;</span><br><span class="line">    <span class="comment"># kubernetes api-server ip地址以及https端口</span></span><br><span class="line">    upstream kube-apiserver &#123;</span><br><span class="line">        server 192.168.1.53:6443     max_fails=3 fail_timeout=30s;</span><br><span class="line">        server 192.168.1.54:6443     max_fails=3 fail_timeout=30s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 监听8443端口，将其接收的流量转发至指定proxy_pass</span></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 8443;</span><br><span class="line">        proxy_connect_timeout 2s;</span><br><span class="line">        proxy_timeout 900s;</span><br><span class="line">        proxy_pass kube-apiserver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</li>
<li><p><strong>启动nginx</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start nginx &amp;&amp; systemctl <span class="built_in">enable</span> nginx &amp;&amp; systemctl status nginx</span><br></pre></td></tr></table></div></figure>

</li>
</ol>

        <h2 id="8-3-keepalived部署"   >
          <a href="#8-3-keepalived部署" class="heading-link"><i class="fas fa-link"></i></a>8.3 keepalived部署</h2>
      <ol>
<li><p><strong>安装keepalived</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install keepalived -y</span><br></pre></td></tr></table></div></figure>
</li>
<li><p><strong>监听脚本</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/keepalived/check_port.sh</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># keepalived 监控端口脚本</span></span><br><span class="line"><span class="comment"># 使用方法：</span></span><br><span class="line"><span class="comment"># 在keepalived的配置文件中</span></span><br><span class="line"><span class="comment"># vrrp_script check_port &#123;# 创建一个vrrp_script脚本,检查配置</span></span><br><span class="line"><span class="comment">#     script "/etc/keepalived/check_port.sh 8443" # 配置监听的端口</span></span><br><span class="line"><span class="comment">#     interval 2 #检查脚本的频率,单位（秒）</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line">CHK_PORT=<span class="variable">$1</span></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$CHK_PORT</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">        PORT_PROCESS=`ss -lnt|grep <span class="variable">$CHK_PORT</span>|wc -l`</span><br><span class="line">        <span class="keyword">if</span> [ <span class="variable">$PORT_PROCESS</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"Port <span class="variable">$CHK_PORT</span> Is Not Used,End."</span></span><br><span class="line">                <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Check Port Cant Be Empty!"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></div></figure>
</li>
<li><p><strong>添加可执行权限</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /etc/keepalived/check_port.sh</span><br></pre></td></tr></table></div></figure>
</li>
<li><p><strong>keepalived主配置文件</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主服务器</span></span><br><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    <span class="comment"># 机器标识符，一般设置为hostname </span></span><br><span class="line">    router_id load-balancer-m</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    <span class="comment"># 调用脚本检测nginx监听的7443端口是否存在</span></span><br><span class="line">    script <span class="string">"/etc/keepalived/check_port.sh 8443"</span></span><br><span class="line">    interval 2</span><br><span class="line">    weight -20</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens192</span><br><span class="line">    <span class="comment"># 虚拟路由组id，两边须一致</span></span><br><span class="line">    virtual_router_id 91</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    <span class="comment"># 当前主机IP</span></span><br><span class="line">    mcast_src_ip 192.168.1.51</span><br><span class="line">    <span class="comment"># 不抢占</span></span><br><span class="line">    nopreempt</span><br><span class="line">    <span class="comment"># 高可用认证</span></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass jeremy  <span class="comment"># 认证密码，两边须一致</span></span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">         chk_nginx</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 虚拟IP</span></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.1.50</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备服务器</span></span><br><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id load-balancer-b</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script <span class="string">"/etc/keepalived/check_port.sh 8443"</span></span><br><span class="line">    interval 2</span><br><span class="line">    weight -20</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens192</span><br><span class="line">    virtual_router_id 91</span><br><span class="line">    mcast_src_ip 192.168.1.52</span><br><span class="line">    priority 90</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass jeremy</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_nginx</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.1.50</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>
</li>
<li><p><strong>启动keepalived</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start keepalived &amp;&amp; systemctl <span class="built_in">enable</span> keepalived &amp;&amp; systemctl status keepalived</span><br></pre></td></tr></table></div></figure>


</li>
</ol>

        <h1 id="9-Node节点部署"   >
          <a href="#9-Node节点部署" class="heading-link"><i class="fas fa-link"></i></a>9. Node节点部署</h1>
      <ul>
<li>k8s-node1：<code>192.168.1.61</code><ul>
<li>kubelet</li>
<li>kube-proxy</li>
</ul>
</li>
<li>k8s-node2：<code>192.168.1.62</code><ul>
<li>kubelet</li>
<li>kube-proxy</li>
</ul>
</li>
</ul>

        <h2 id="9-1-kubelet部署"   >
          <a href="#9-1-kubelet部署" class="heading-link"><i class="fas fa-link"></i></a>9.1 kubelet部署</h2>
      <ol>
<li><strong>下载地址</strong></li>
</ol>
<p><span class="exturl"><a class="exturl__link"   href="https://dl.k8s.io/v1.18.10/kubernetes-node-linux-amd64.tar.gz"  target="_blank" rel="noopener">下载地址</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<ol start="2">
<li><strong>部署</strong></li>
</ol>
<blockquote>
<p>kubernetes-node包里面的二进制文件跟kubernetes-server包里面给的是一样的</p>
</blockquote>
<ul>
<li><p>解压压缩包即可<br><code>tar -xzvf kubernetes-node-linux-amd64.tar.gz</code></p>
</li>
<li><p>创建文件夹<br><code>mkdir /opt/kubernetes/node/{cert,conf.d,logs}</code></p>
</li>
</ul>
<ol start="3">
<li><strong>准备pause基础镜像</strong></li>
</ol>
<blockquote>
<p>pause镜像是k8s里必不可少的以pod方式运行业务容器时的一个基础容器。</p>
</blockquote>
<ul>
<li><p>在harbor上拉取镜像：<code>docker pull kubernetes/pause</code></p>
</li>
<li><p>上传镜像到harbor仓库</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker tag f9d5de079539 harbor.jeremy.cn/public/pause:latest</span><br><span class="line">docker push harbor.jeremy.cn/public/pause:latest</span><br></pre></td></tr></table></div></figure>
</li>
</ul>
<ol start="4">
<li><p><strong>登录harbor，创建目录，拷贝证书，环境变量</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建数据存储目录</span></span><br><span class="line">mkdir /opt/kubernetes/kubeletData</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录harbor</span></span><br><span class="line">docker login harbor.jeremy.cn</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝证书</span></span><br><span class="line">scp /root/ssl/ca.pem k8s-node1:/opt/kubernetes/node/cert</span><br><span class="line">scp /root/ssl/ca.pem k8s-node2:/opt/kubernetes/node/cert</span><br><span class="line"></span><br><span class="line"><span class="comment"># 环境变量</span></span><br><span class="line">vim /etc/profile</span><br><span class="line"><span class="comment"># kubernetes</span></span><br><span class="line">PATH=/opt/kubernetes/node/bin:<span class="variable">$PATH</span>:<span class="variable">$HOME</span>/bin</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></div></figure>
</li>
<li><p><strong>创建配置文件</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/node/conf.d/kubelet.conf &lt;&lt; EOF</span><br><span class="line">KUBELET_OPTS=<span class="string">"--hostname-override=k8s-node1 \  # 需要修改</span></span><br><span class="line"><span class="string">    --kubeconfig=/opt/kubernetes/node/conf.d/kubelet.kubeconfig \</span></span><br><span class="line"><span class="string">    --bootstrap-kubeconfig=/opt/kubernetes/node/conf.d/kubelet-bootstrap.kubeconfig \</span></span><br><span class="line"><span class="string">    --config=/opt/kubernetes/node/conf.d/kubelet-config.yml \</span></span><br><span class="line"><span class="string">    --cert-dir=/opt/kubernetes/node/cert \</span></span><br><span class="line"><span class="string">    --pod-infra-container-image=harbor.jeremy.cn/public/pause:latest \</span></span><br><span class="line"><span class="string">    --network-plugin=cni \</span></span><br><span class="line"><span class="string">    --cni-conf-dir=/etc/cni/net.d \</span></span><br><span class="line"><span class="string">    --cni-bin-dir=/opt/cni/bin \</span></span><br><span class="line"><span class="string">    --root-dir=/opt/kubernetes/kubeletData \</span></span><br><span class="line"><span class="string">    --log-dir=/opt/kubernetes/node/logs \</span></span><br><span class="line"><span class="string">    --logtostderr=false \</span></span><br><span class="line"><span class="string">    --v=2"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>
<blockquote>
<p><strong>参数说明：</strong><br><code>--hostname-override</code>：显示名称，集群中唯一（需要修改）<br><code>--kubeconfig</code>：空路径，会自动生成，后面用于连接apiserver<br><code>--bootstrap-kubeconfig</code>：首次启动向apiserver申请证书<br><code>--config</code>：配置参数文件<br><code>--cert-dir</code>：kubelet证书生成目录<br><code>--pod-infra-container-image</code>：管理Pod网络容器的镜像(这里用的是我们上传到harbor的pause镜像)<br><code>--root-dir</code>：设置用于管理 kubelet 文件的根目录（例如挂载卷的相关文件）（默认值为 “/var/lib/kubelet”）<br><code>--network-plugin</code>：启用cni，后面会部署fannel网络组件</p>
</blockquote>
</li>
</ol>
<ol start="6">
<li><p><strong>配置参数文件</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/node/conf.d/kubelet-config.yml &lt;&lt; EOF</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">address: 0.0.0.0</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">cgroupDriver: cgroupfs</span><br><span class="line">clusterDNS:</span><br><span class="line">- 192.168.80.2</span><br><span class="line">clusterDomain: cluster.local </span><br><span class="line">failSwapOn: <span class="literal">false</span></span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: <span class="literal">false</span></span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /opt/kubernetes/node/cert/ca.pem </span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 5m0s</span><br><span class="line">    cacheUnauthorizedTTL: 30s</span><br><span class="line">evictionHard:</span><br><span class="line">  imagefs.available: 15%</span><br><span class="line">  memory.available: 100Mi</span><br><span class="line">  nodefs.available: 10%</span><br><span class="line">  nodefs.inodesFree: 5%</span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">maxPods: 110</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>
</li>
<li><p><strong>生成kubeconfig文件</strong></p>
</li>
</ol>
<ul>
<li><p>先写一个kubelet-boot.sh 脚本 把下面的内容放进去</p>
</li>
<li><p><code>vim /opt/kubernetes/node/kubelet-boot.sh</code></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">KUBE_APISERVER=<span class="string">"https://192.168.1.50:8443"</span>  <span class="comment"># apiserver VIP:PORT</span></span><br><span class="line">BOOTSTRAP_TOKEN=<span class="string">"68b1ebf648614412dedc47208d3a45cf"</span>  <span class="comment"># 与token.csv里保持一致</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成 kubelet bootstrap kubeconfig 配置文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置集群参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/node/cert/ca.pem  \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kubelet-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置客户端认证参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials <span class="string">"kubelet-bootstrap"</span> \</span><br><span class="line">  --token=<span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span> \</span><br><span class="line">  --kubeconfig=kubelet-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置上下文参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=<span class="string">"kubelet-bootstrap"</span> \</span><br><span class="line">  --kubeconfig=kubelet-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置默认上下文</span></span><br><span class="line">kubectl config use-context default --kubeconfig=kubelet-bootstrap.kubeconfig</span><br></pre></td></tr></table></div></figure>

</li>
</ul>
<blockquote>
<p>–embed-certs 为 true 时表示将 certificate-authority 证书写入到生成的 bootstrap.kubeconfig 文件中；<br>设置客户端认证参数时没有指定秘钥和证书，后续由 kube-apiserver 自动生成；</p>
</blockquote>
<ul>
<li>生成<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/kubernetes/node/conf.d</span><br><span class="line">sh /opt/kubernetes/node/kubelet-boot.sh</span><br></pre></td></tr></table></div></figure>


</li>
</ul>
<ol start="8">
<li><p><strong>启动并设置开机启动</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kubelet</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line">systemctl status kubelet</span><br></pre></td></tr></table></div></figure>
</li>
<li><p><strong>批准kubelet证书申请并加入集群</strong></p>
</li>
</ol>
<ul>
<li>查看kubelet证书请求<br><code>kubectl get csr</code></li>
</ul>
<p><img src="/images/k8s-png/12.%E6%9F%A5%E7%9C%8Bkubelet%E8%AF%81%E4%B9%A6%E8%AF%B7%E6%B1%82.png" alt="12.查看kubelet证书请求.png"></p>
<ul>
<li>批准申请<br><code>kubectl certificate approve name</code></li>
</ul>
<p><img src="/images/k8s-png/13.%E6%89%B9%E5%87%86%E7%94%B3%E8%AF%B7-1.png" alt="13.批准申请-1.png"></p>
<p><img src="/images/k8s-png/13.%E6%89%B9%E5%87%86%E7%94%B3%E8%AF%B7-2.png" alt="13.批准申请-1.png"></p>

        <h2 id="9-2-kube-proxy部署"   >
          <a href="#9-2-kube-proxy部署" class="heading-link"><i class="fas fa-link"></i></a>9.2 kube-proxy部署</h2>
      <ol>
<li><p><strong>创建配置文件</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/node/conf.d/kube-proxy.conf &lt;&lt; EOF</span><br><span class="line">KUBE_PROXY_OPTS=<span class="string">"--config=/opt/kubernetes/node/conf.d/kube-proxy-config.yml \\</span></span><br><span class="line"><span class="string">    --log-dir=/opt/kubernetes/node/logs \\</span></span><br><span class="line"><span class="string">    --logtostderr=false \\</span></span><br><span class="line"><span class="string">    --v=2"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>
</li>
<li><p><strong>配置参数文件</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/node/conf.d/kube-proxy-config.yml &lt;&lt; EOF</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">metricsBindAddress: 0.0.0.0:10249</span><br><span class="line">clientConnection:</span><br><span class="line">  kubeconfig: /opt/kubernetes/node/conf.d/kube-proxy.kubeconfig</span><br><span class="line">hostnameOverride: k8s-node1</span><br><span class="line">clusterCIDR: 192.168.80.0/24</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>
<blockquote>
<p>修改hostnameOverride</p>
</blockquote>
</li>
<li><p><strong>创建证书</strong></p>
</li>
</ol>
<ul>
<li><strong>查看 3.8 创建kube-proxy证书</strong></li>
</ul>
<ol start="4">
<li><p><strong>拷贝证书</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp /root/ssl/&#123;kube-proxy.pem,kube-proxy-key.pem&#125; k8s-node1:/opt/kubernetes/node/cert</span><br><span class="line">scp /root/ssl/&#123;kube-proxy.pem,kube-proxy-key.pem&#125; k8s-node2:/opt/kubernetes/node/cert</span><br></pre></td></tr></table></div></figure>
</li>
<li><p><strong>生成kubeconfig文件</strong></p>
</li>
</ol>
<ul>
<li><p>先写一个kube-proxy-boot.sh 脚本 把下面的内容放进去</p>
</li>
<li><p><code>vim /opt/kubernetes/node/kube-proxy-boot.sh</code></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">KUBE_APISERVER=<span class="string">"https://192.168.1.50:8443"</span>  <span class="comment"># apiserver VIP:PORT</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成 kube-proxy bootstrap kubeconfig 配置文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置集群参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/node/cert/ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"> </span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials kube-proxy \</span><br><span class="line">  --client-certificate=/opt/kubernetes/node/cert/kube-proxy.pem \</span><br><span class="line">  --client-key=/opt/kubernetes/node/cert/kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"> </span><br><span class="line">kubectl config <span class="built_in">set</span>-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"> </span><br><span class="line">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br></pre></td></tr></table></div></figure>
</li>
<li><p>生成</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/kubernetes/node/conf.d</span><br><span class="line">sh /opt/kubernetes/node/kube-proxy-boot.sh</span><br></pre></td></tr></table></div></figure>
</li>
</ul>
<ol start="6">
<li><p><strong>systemd管理kube-proxy</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-proxy.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Proxy</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/node/conf.d/kube-proxy.conf</span><br><span class="line">ExecStart=/opt/kubernetes/node/bin/kube-proxy \<span class="variable">$KUBE_PROXY_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>
</li>
<li><p><strong>启动并设置开机启动</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-proxy</span><br><span class="line">systemctl <span class="built_in">enable</span> kube-proxy</span><br><span class="line">systemctl status kube-proxy</span><br></pre></td></tr></table></div></figure>


</li>
</ol>

        <h1 id="10-fannel网络组件部署"   >
          <a href="#10-fannel网络组件部署" class="heading-link"><i class="fas fa-link"></i></a>10. fannel网络组件部署</h1>
      <ul>
<li>部署思路：<ul>
<li><ol>
<li>在node上下载cni依赖插件</li>
</ol>
</li>
<li><ol start="2">
<li>在master上执行kube-flannel.yml</li>
</ol>
</li>
</ul>
</li>
</ul>

        <h2 id="10-1-在kubelet中指定三个参数"   >
          <a href="#10-1-在kubelet中指定三个参数" class="heading-link"><i class="fas fa-link"></i></a>10.1 在kubelet中指定三个参数</h2>
      <blockquote>
<p><strong>这个本实例不需要，因为在部署kubelet的时候已经加了cni配置了</strong></p>
</blockquote>
<ul>
<li><code>vim /opt/kubernetes/node/conf.d/kubelet.conf</code><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--network-plugin=cni : 网络插件使用cni</span><br><span class="line">--cni-conf-dir=/etc/cni/net.d cni : 配置文件(默认)</span><br><span class="line">--cni-bin-dir=/opt/cni/bin cni : 可执行文件(默认)</span><br></pre></td></tr></table></div></figure>

</li>
</ul>
<p><img src="/images/k8s-png/14.%E5%9C%A8kubelet%E4%B8%AD%E6%8C%87%E5%AE%9A%E4%B8%89%E4%B8%AA%E5%8F%82%E6%95%B0.png" alt="14.在kubelet中指定三个参数.png"></p>
<ul>
<li><p>重启服务</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart kubelet &amp;&amp; systemctl status kubelet</span><br></pre></td></tr></table></div></figure>
</li>
<li><p>这样在kublet启动的时候，就会去<code>/etc/cni/net.d</code>目录查找配置文件，并解析，使用相应的插件配置网络，因此之前<code>node</code>会从<code>Ready</code>变为<code>NotReady</code></p>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 logs]# kubectl get nodes</span><br><span class="line">NAME        STATUS     ROLES    AGE   VERSION</span><br><span class="line">k8s-node1   NotReady   <span class="tag">&lt;<span class="name">none</span>&gt;</span>   22h   v1.18.10</span><br><span class="line">k8s-node2   NotReady   <span class="tag">&lt;<span class="name">none</span>&gt;</span>   22h   v1.18.10</span><br></pre></td></tr></table></div></figure>

</li>
</ul>

        <h2 id="10-2-下载cni依赖插件"   >
          <a href="#10-2-下载cni依赖插件" class="heading-link"><i class="fas fa-link"></i></a>10.2 下载cni依赖插件</h2>
      <ol>
<li><p><strong>先准备好CNI二进制文件</strong><br><span class="exturl"><a class="exturl__link"   href="https://github.com/containernetworking/plugins/releases/download/v0.8.7/cni-plugins-linux-amd64-v0.8.7.tgz"  target="_blank" rel="noopener">下载地址</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</li>
<li><p><strong>解压二进制包并移动到默认工作目录</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /opt/cni/bin -p</span><br><span class="line">tar xzvf cni-plugins-linux-amd64-v0.8.7.tgz -C /opt/cni/bin</span><br></pre></td></tr></table></div></figure>

</li>
</ol>

        <h2 id="10-3-flannel网络组件部署"   >
          <a href="#10-3-flannel网络组件部署" class="heading-link"><i class="fas fa-link"></i></a>10.3 flannel网络组件部署</h2>
      <blockquote>
<p><strong>在master上进行此步操作</strong></p>
</blockquote>
<ol>
<li><p><strong>下载yml文件</strong><br>wget <span class="exturl"><a class="exturl__link"   href="https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml"  target="_blank" rel="noopener">https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</li>
<li><p><strong>修改yml文件</strong> - 子网，工作模式</p>
</li>
</ol>
<blockquote>
<p>此处的<code>network</code>配置要与<code>Pod Network</code>(<code>--service-cluster-ip-range</code>)配置的一致</p>
</blockquote>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">net-conf.json: |</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"Network"</span>: <span class="string">"192.168.80.0/24"</span>,</span><br><span class="line">    <span class="string">"Backend"</span>: &#123;</span><br><span class="line">    <span class="string">"Type"</span>: <span class="string">"vxlan"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>Backend (工作模式)</p>
<ul>
<li><code>Host-gw</code>: 同一网段直接通信，速度快</li>
<li><code>udp</code>： 用户空间的udp封装</li>
<li><code>vxlan</code>: 利用内核vxlan协议进行传输（推荐）</li>
<li><code>aws vpc</code>: 利用aws平台内部提供的功能进行传输</li>
</ul>
</blockquote>
<ol start="3">
<li><strong>修改网卡</strong></li>
</ol>
<blockquote>
<p>目前需要在<code>kube-flannel.yml</code>中使用<code>- --iface</code>参数指定集群主机内网网卡的名称，否则可能会出现dns无法解析。</p>
</blockquote>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">command</span>:</span><br><span class="line">- /opt/bin/flanneld</span><br><span class="line">args:</span><br><span class="line">- --ip-masq</span><br><span class="line">- --kube-subnet-mgr</span><br><span class="line">- --iface=ens192</span><br></pre></td></tr></table></div></figure>

<ol start="4">
<li><strong>准备镜像（目前不需要了）</strong></li>
</ol>
<ul>
<li>这一步目前好像不需要了，国内对v13版本的镜像好像可以直接拉去，如果不行，则只能按下面步骤进行操作</li>
</ul>
<blockquote>
<p>在国内下载<code>flannel</code>镜像同样很容易失败，因此建议提前下载好，再去启动<code>flannel DaemonSet</code>，避免在启动过程中重试浪费时间。（如果能科学上网，则可以下来下载，然后再进行手动导入)(本实例使用自己导入的镜像）<br>国内flannel镜像获取查看：<span class="exturl"><a class="exturl__link"   href="https://www.cnblogs.com/xiao987334176/p/12696740.html#autoid-6-1-0"  target="_blank" rel="noopener">https://www.cnblogs.com/xiao987334176/p/12696740.html#autoid-6-1-0</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br>下载flannel镜像</p>
</blockquote>
<ul>
<li><p>手动下载时镜像名称最好从<code>kube-flannel.yml</code>文件中拷贝，确保下载正确的镜像。</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull quay.io/coreos/flannel:v0.13.0</span><br></pre></td></tr></table></div></figure>
</li>
<li><p>导入镜像 并 修改好导入的镜像名称，跟配置文件名称保持一致</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker load -i quay.io-coreos-flannel_v0.13.0.tar.gz</span><br><span class="line">docker tag e708f4bb69e3 quay.io/coreos/flannel:v0.13.0</span><br></pre></td></tr></table></div></figure>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">initContainers:</span><br><span class="line">- name: install-cni</span><br><span class="line">  image: quay.io/coreos/flannel:v0.13.0  <span class="comment"># 配置文件中</span></span><br></pre></td></tr></table></div></figure>
</li>
</ul>
<ol start="5">
<li><strong>在master上运行</strong><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kube-flannel.yml</span><br><span class="line">kubectl get pods -n kube-system</span><br></pre></td></tr></table></div></figure>

</li>
</ol>
<p>![15.kubectl get pods -n kube-system.png](/images/k8s-png/15.kubectl get pods -n kube-system.png)</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br></pre></td></tr></table></div></figure>

<p>![16.kubectl get node.png](/images/k8s-png/16.kubectl get node.png)</p>

        <h1 id="11-Dashboard和CoreDNS部署"   >
          <a href="#11-Dashboard和CoreDNS部署" class="heading-link"><i class="fas fa-link"></i></a>11. Dashboard和CoreDNS部署</h1>
      
        <h2 id="11-1-Dashboard部署"   >
          <a href="#11-1-Dashboard部署" class="heading-link"><i class="fas fa-link"></i></a>11.1 Dashboard部署</h2>
      <ol>
<li><strong>简介</strong><blockquote>
<p>在 Kubernetes 社区中，有一个很受欢迎的 Dashboard 项目，它可以给用户提供一个可视化的 Web 界面来查看当前集群的各种信息。用户可以用 Kubernetes Dashboard 部署容器化的应用、监控应用的状态、执行故障排查任务以及管理 Kubernetes 各种资源。</p>
</blockquote>
</li>
</ol>
<p><img src="/images/k8s-png/17.Dashboard%E7%AE%80%E4%BB%8B%E5%9B%BE.png" alt="17.Dashboard简介图.png"></p>
<ol start="2">
<li><strong>相关地址</strong><br><span class="exturl"><a class="exturl__link"   href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/"  target="_blank" rel="noopener">官方参考文档</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ol>
<p><span class="exturl"><a class="exturl__link"   href="https://github.com/kubernetes/dashboard"  target="_blank" rel="noopener">github项目地址</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>当前部署dashboard版本：v2.0.3，注意检查dashboard版本与kubernetes版本兼容性：<br><span class="exturl"><a class="exturl__link"   href="https://github.com/kubernetes/dashboard/releases/tag/v2.0.3"  target="_blank" rel="noopener">https://github.com/kubernetes/dashboard/releases/tag/v2.0.3</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="/images/k8s-png/18.Dashboard-github.png" alt="18.Dashboard-github.png"></p>
<ol start="3">
<li><p><strong>下载yaml文件</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.3/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></div></figure>
</li>
<li><p><strong>修改yaml文件</strong></p>
</li>
</ol>
<ul>
<li>vim recommended.yaml<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.....................</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 443</span><br><span class="line">      targetPort: 8443</span><br><span class="line">      nodePort: 38443</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">.....................</span><br></pre></td></tr></table></div></figure>

</li>
</ul>
<p><img src="/images/k8s-png/19.recommended.yaml.png" alt="19.recommended.yaml.png"></p>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 yaml]# kubectl get pods -n kubernetes-dashboard </span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">dashboard-metrics-scraper-6b4884c9d5-26ql5   1/1     Running   0          6m6s</span><br><span class="line">kubernetes-dashboard-7f99b75bf4-78v9n        1/1     Running   0          6m7s</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 yaml]# kubectl get svc -n kubernetes-dashboard </span><br><span class="line">NAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">dashboard-metrics-scraper   ClusterIP   192.168.80.215   <span class="tag">&lt;<span class="name">none</span>&gt;</span>        8000/TCP        6m8s</span><br><span class="line">kubernetes-dashboard        NodePort    192.168.80.211   <span class="tag">&lt;<span class="name">none</span>&gt;</span>        443:38443/TCP   2m48s</span><br></pre></td></tr></table></div></figure>

<ol start="5">
<li><strong>登录dashboard</strong></li>
</ol>
<ul>
<li>浏览器访问dashboard：<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://<span class="tag">&lt;<span class="name">any_node_ip</span>&gt;</span>:38443</span><br></pre></td></tr></table></div></figure>

</li>
</ul>
<p><img src="/images/k8s-png/20.%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AEdashboard.png" alt="20.浏览器访问dashboard.png"></p>
<ul>
<li><strong>Dashboard 支持 Kubeconfig 和 Token 两种认证方式，我们这里选择Token认证方式登录。</strong></li>
</ul>
<p><span class="exturl"><a class="exturl__link"   href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md"  target="_blank" rel="noopener">官方参考文档</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<ul>
<li><p><strong>创建dashboard-adminuser.yaml</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; dashboard-adminuser.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard  </span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>
</li>
<li><p><strong>创建登录用户</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f dashboard-adminuser.yaml</span><br></pre></td></tr></table></div></figure>

</li>
</ul>
<blockquote>
<p>说明：上面创建了一个叫<code>admin-user</code>的服务账号，并放在<code>kubernetes-dashboard</code> 命名空间下，并将<code>cluster-admin</code>角色绑定到<code>admin-user</code>账户，这样<code>admin-user</code>账户就有了管理员的权限。默认情况下，<code>kubeadm</code>创建集群时已经创建了<code>cluster-admin</code>角色，我们直接绑定即可。</p>
</blockquote>
<ul>
<li><strong>查看admin-user账户的token</strong><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep admin-user | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br></pre></td></tr></table></div></figure>

</li>
</ul>
<p><img src="/images/k8s-png/21.%E6%9F%A5%E7%9C%8Badmin-user%E8%B4%A6%E6%88%B7%E7%9A%84token.png" alt="21.查看admin-user账户的token.png"></p>
<ul>
<li><strong>把token粘贴到登录窗口，然后登录</strong><br><img src="/images/k8s-png/22.%E7%99%BB%E5%BD%95dashboard-1.png" alt="22.登录dashboard-1.png"></li>
</ul>
<p><img src="/images/k8s-png/22.%E7%99%BB%E5%BD%95dashboard-2.png" alt="22.登录dashboard-1.png"></p>

        <h2 id="11-2-CoreDNS部署"   >
          <a href="#11-2-CoreDNS部署" class="heading-link"><i class="fas fa-link"></i></a>11.2 CoreDNS部署</h2>
      <ol>
<li><p><strong>下载官方yaml文件样板</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/kubernetes/master/cluster/addons/dns/coredns/coredns.yaml.base</span><br><span class="line">cp coredns.yaml.base coredns.yaml</span><br></pre></td></tr></table></div></figure>
</li>
<li><p><strong>修改yaml文件</strong></p>
</li>
</ol>
<ul>
<li><p>70行：<code>__DNS__DOMAIN__</code> 改为<code>cluster.local</code>(这个值跟kubelet-config.yml文件内的<code>clusterDomain</code>值一致)</p>
</li>
<li><p>139行：<code>__DNS__MEMORY__LIMIT__</code>改为<code>160Mi</code></p>
</li>
<li><p>205行：<code>__DNS__SERVER__</code>改为<code>192.168.80.2</code>（这个值跟kubelet-config.yml文件内的<code>clusterDNS</code>值一致）</p>
</li>
<li><p>注释112-114</p>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">      securityContext:</span><br><span class="line">        seccompProfile:</span><br><span class="line">          type: RuntimeDefault</span><br></pre></td></tr></table></div></figure>
</li>
<li><p>修改镜像 135行 (下面是我上传到阿里镜像仓库的镜像)<br><code>registry.cn-hangzhou.aliyuncs.com/jeremy865/k8s-coredns:1.7.0</code></p>
</li>
</ul>
<ol start="3">
<li><strong>启动</strong><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f coredns.yaml</span><br></pre></td></tr></table></div></figure>
</li>
</ol>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="https://jeremy-zjl.github.io">Jeremy-ZJL</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="https://jeremy-zjl.github.io/2020/03/10/K8S%E4%B8%A8%E5%AE%89%E8%A3%85%E4%B8%A8%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%B9%E5%BC%8F%E9%83%A8%E7%BD%B2/">https://jeremy-zjl.github.io/2020/03/10/K8S%E4%B8%A8%E5%AE%89%E8%A3%85%E4%B8%A8%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%B9%E5%BC%8F%E9%83%A8%E7%BD%B2/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://jeremy-zjl.github.io/tags/K8S/">K8S</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://jeremy-zjl.github.io/tags/Kubernetes/">Kubernetes</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2020/03/10/K8S%E4%B8%A81.%20Kubernetes%E4%BB%8B%E7%BB%8D/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">K8S丨1. Kubernetes介绍</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2020/01/30/Anaconda%E5%92%8CMiniconda%E7%9A%84%E4%BD%BF%E7%94%A8/"><span class="paginator-prev__text">Anaconda和Miniconda的使用</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div><div class="comments" id="comments"><div id="gitalk-container"></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-环境说明"><span class="toc-text">
          1. 环境说明</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-阿里yum源，epel源"><span class="toc-text">
          1.1 阿里yum源，epel源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-关闭防火墙、selinux、swap，设置hostname，时间同步"><span class="toc-text">
          1.2 关闭防火墙、selinux、swap，设置hostname，时间同步</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-Linux内核优化"><span class="toc-text">
          1.3 Linux内核优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-必要工具"><span class="toc-text">
          1.4 必要工具</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-DNS部署"><span class="toc-text">
          2. DNS部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-安装"><span class="toc-text">
          2.1 安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-主配置文件"><span class="toc-text">
          2.2 主配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-区域配置文件"><span class="toc-text">
          2.3 区域配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-配置区域数据文件"><span class="toc-text">
          2.4 配置区域数据文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-启动DNS服务"><span class="toc-text">
          2.5 启动DNS服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-验证是否可解析"><span class="toc-text">
          2.6 验证是否可解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-7-设置search-短域名"><span class="toc-text">
          2.7 设置search(短域名)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-创建TLS证书及密钥"><span class="toc-text">
          3. 创建TLS证书及密钥</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-证书说明"><span class="toc-text">
          3.1 证书说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-安装证书制作工具-CFSSL"><span class="toc-text">
          3.2 安装证书制作工具-CFSSL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-创建ca-pem和ca-key-pem"><span class="toc-text">
          3.3 创建ca.pem和ca-key.pem</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-CA配置文件"><span class="toc-text">
          3.3.1 CA配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-CA证书申请表-生成CA自签名请求"><span class="toc-text">
          3.3.2 CA证书申请表(生成CA自签名请求)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-3-生成ca-pem-ca-key-pem"><span class="toc-text">
          3.3.3 生成ca.pem&#x2F;ca-key.pem</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-创建etcd-pem和etcd-key-pem"><span class="toc-text">
          3.4 创建etcd.pem和etcd-key.pem</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-etcd证书申请表"><span class="toc-text">
          3.4.1 etcd证书申请表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-生成etcd-pem-etcd-key-pem"><span class="toc-text">
          3.4.2 生成etcd.pem&#x2F;etcd-key.pem</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-创建apiserver-pem和apiserver-key-pem"><span class="toc-text">
          3.5 创建apiserver.pem和apiserver-key.pem</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-1-k8s-apiserver证书申请表"><span class="toc-text">
          3.5.1 k8s-apiserver证书申请表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-2-生成apiserver-pem-apiserver-key-pem"><span class="toc-text">
          3.5.2 生成apiserver.pem&#x2F;apiserver-key.pem</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6-创建client证书"><span class="toc-text">
          3.6 创建client证书</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-1-client证书申请表"><span class="toc-text">
          3.6.1 client证书申请表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-2-生成client-pem-client-key-pem"><span class="toc-text">
          3.6.2 生成client.pem&#x2F;client-key.pem</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-7-创建kubelet证书"><span class="toc-text">
          3.7 创建kubelet证书</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-1-kubelet证书申请表"><span class="toc-text">
          3.7.1 kubelet证书申请表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-2-生成kubelet证书和私钥"><span class="toc-text">
          3.7.2 生成kubelet证书和私钥</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-8-创建kube-proxy证书"><span class="toc-text">
          3.8 创建kube-proxy证书</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-1-kube-proxy证书申请表"><span class="toc-text">
          3.8.1 kube-proxy证书申请表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-2-生成kube-proxy证书和私钥"><span class="toc-text">
          3.8.2 生成kube-proxy证书和私钥</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-Etcd集群部署"><span class="toc-text">
          4. Etcd集群部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-安装"><span class="toc-text">
          4.1 安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-创建证书"><span class="toc-text">
          4.2 创建证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-各etcd节点配置文件"><span class="toc-text">
          4.3 各etcd节点配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-systemd管理etcd"><span class="toc-text">
          4.4 systemd管理etcd</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-检查etcd集群节点健康情况"><span class="toc-text">
          4.5 检查etcd集群节点健康情况</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-Docker部署"><span class="toc-text">
          5. Docker部署</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-Harbor部署"><span class="toc-text">
          6. Harbor部署</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-Master节点部署"><span class="toc-text">
          7. Master节点部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-kube-apiserver部署"><span class="toc-text">
          7.1 kube-apiserver部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-kube-controller-manager部署"><span class="toc-text">
          7.2 kube-controller-manager部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-kube-scheduler部署"><span class="toc-text">
          7.3 kube-scheduler部署</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-L4反向代理"><span class="toc-text">
          8. L4反向代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-拓扑图"><span class="toc-text">
          8.1 拓扑图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-nginx部署"><span class="toc-text">
          8.2 nginx部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-keepalived部署"><span class="toc-text">
          8.3 keepalived部署</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-Node节点部署"><span class="toc-text">
          9. Node节点部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-kubelet部署"><span class="toc-text">
          9.1 kubelet部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-kube-proxy部署"><span class="toc-text">
          9.2 kube-proxy部署</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-fannel网络组件部署"><span class="toc-text">
          10. fannel网络组件部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1-在kubelet中指定三个参数"><span class="toc-text">
          10.1 在kubelet中指定三个参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2-下载cni依赖插件"><span class="toc-text">
          10.2 下载cni依赖插件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-3-flannel网络组件部署"><span class="toc-text">
          10.3 flannel网络组件部署</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11-Dashboard和CoreDNS部署"><span class="toc-text">
          11. Dashboard和CoreDNS部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#11-1-Dashboard部署"><span class="toc-text">
          11.1 Dashboard部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-2-CoreDNS部署"><span class="toc-text">
          11.2 CoreDNS部署</span></a></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/j-icon-144.png" alt="avatar"></div><p class="sidebar-ov-author__text">write code and love life</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="https://plus.google.com/" target="_blank" rel="noopener" data-popover="Google" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-google"></i></span></a><a class="sidebar-ov-social-item" href="https://www.zhihu.com/" target="_blank" rel="noopener" data-popover="知乎" data-popover-pos="up"><span class="sidebar-ov-social-item__icon">知</span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">26</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">7</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">19</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2020</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>Jeremy All Rights Reserved</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v4.2.1</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.0.1</span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__info">访问人数</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__info">浏览总量</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/ribbon.js@latest/dist/ribbon.min.js" size="200" alpha="0.6" zIndex="-1"></script><script src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1.0.1/dist/canvas-nest.min.js" color="0,0,0" opacity="0.6" count="180" zIndex="-1"></script><script src="https://cdn.jsdelivr.net/npm/pjax@latest/pjax.min.js"></script><script>window.addEventListener('DOMContentLoaded', function () {
  var pjax = new Pjax({"selectors":["head title","#main",".pjax-reload",".header-inner"],"history":true,"scrollTo":false,"scrollRestoration":false,"cacheBust":false,"debug":false,"currentUrlFullReload":false,"timeout":0});
  // 加载进度条的计时器
  var loadingTimer = null;

  // 重置页面 Y 方向上的滚动偏移量
  document.addEventListener('pjax:send', function () {
    $('.header-nav-menu').removeClass('show');
    if (CONFIG.pjax && CONFIG.pjax.avoidBanner) {
      $('html').velocity('scroll', {
        duration: 500,
        offset: $('#header').height(),
        easing: 'easeInOutCubic'
      });
    }

    var loadingBarWidth = 20;
    var MAX_LOADING_WIDTH = 95;

    $('.loading-bar').addClass('loading');
    $('.loading-bar__progress').css('width', loadingBarWidth + '%');
    clearInterval(loadingTimer);
    loadingTimer = setInterval(function () {
      loadingBarWidth += 3;
      if (loadingBarWidth > MAX_LOADING_WIDTH) {
        loadingBarWidth = MAX_LOADING_WIDTH;
      }
      $('.loading-bar__progress').css('width', loadingBarWidth + '%');
    }, 500);
  }, false);

  window.addEventListener('pjax:complete', function () {
    clearInterval(loadingTimer);
    $('.loading-bar__progress').css('width', '100%');
    $('.loading-bar').removeClass('loading');
    setTimeout(function () {
      $('.loading-bar__progress').css('width', '0');
    }, 400);
    $('link[rel=prefetch], script[data-pjax-rm]').each(function () {
      $(this).remove();
    });
    $('script[data-pjax], #pjax-reload script').each(function () {
      $(this).parent().append($(this).remove());
    });

    if (Stun.utils.pjaxReloadBoot) {
      Stun.utils.pjaxReloadBoot();
    }
    if (Stun.utils.pjaxReloadScroll) {
      Stun.utils.pjaxReloadScroll();
    }
    if (Stun.utils.pjaxReloadSidebar) {
      Stun.utils.pjaxReloadSidebar();
    }
    if (true) {
      if (Stun.utils.pjaxReloadHeader) {
        Stun.utils.pjaxReloadHeader();
      }
      if (Stun.utils.pjaxReloadScrollIcon) {
        Stun.utils.pjaxReloadScrollIcon();
      }
      if (Stun.utils.pjaxReloadLocalSearch) {
        Stun.utils.pjaxReloadLocalSearch();
      }
    }
  }, false);
}, false);</script><div id="pjax-reload"><script src="https://cdn.jsdelivr.net/npm/quicklink@1.0.1/dist/quicklink.umd.js"></script><script>function initQuicklink() {
  quicklink({
    timeout: '10000',
    priority: true,
    ignores: [uri => uri.includes('#'), uri => uri === 'https://jeremy-zjl.github.io/2020/03/10/K8S%E4%B8%A8%E5%AE%89%E8%A3%85%E4%B8%A8%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%B9%E5%BC%8F%E9%83%A8%E7%BD%B2/', /\/api\/?/,uri => uri.includes('.xml'),uri => uri.includes('.zip'),(uri, el) => el.hasAttribute('nofollow'),(uri, el) => el.hasAttribute('noprefetch')]
  });
}

if (true || false) {
  initQuicklink();
} else {
  window.addEventListener('DOMContentLoaded', initQuicklink, false);
}</script><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script></div><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js" data-pjax=""></script><script src="https://cdn.jsdelivr.net/npm/js-md5@latest/src/md5.min.js" data-pjax=""></script><script data-pjax="">function loadGitalk () {
  if (!document.getElementById('gitalk-container')) {
    return;
  }

  var gitalk = new Gitalk({
    id: md5(window.location.pathname.slice(1)),
    clientID: '579a42cc7c084de54dc1',
    clientSecret: '83ac92724b82e3b9c61d46f8b789f717e31b96a5',
    repo: 'Jeremy-ZJL.github.io',
    owner: 'Jeremy-ZJL',
    admin: ['Jeremy-ZJL'],
    distractionFreeMode: 'true',
    language: 'zh-CN'
  });
  gitalk.render('gitalk-container');
}

if (true) {
  loadGitalk();
} else {
  window.addEventListener('DOMContentLoaded', loadGitalk, false);
}</script><script src="/js/utils.js?v=2.0.1"></script><script src="/js/stun-boot.js?v=2.0.1"></script><script src="/js/scroll.js?v=2.0.1"></script><script src="/js/header.js?v=2.0.1"></script><script src="/js/sidebar.js?v=2.0.1"></script></body></html>